{"version":3,"sources":["../../src/addresses/addresses.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateAddressDto, UpdateAddressDto } from './dto';\r\n\r\n@Injectable()\r\nexport class AddressesService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async findAll(userId: string) {\r\n    return this.prisma.address.findMany({\r\n      where: { userId },\r\n      orderBy: [{ isDefault: 'desc' }, { createdAt: 'desc' }],\r\n    });\r\n  }\r\n\r\n  async findOne(id: string, userId: string) {\r\n    const address = await this.prisma.address.findFirst({\r\n      where: { id, userId },\r\n    });\r\n\r\n    if (!address) {\r\n      throw new NotFoundException('Địa chỉ không tồn tại');\r\n    }\r\n\r\n    return address;\r\n  }\r\n\r\n  async create(userId: string, dto: CreateAddressDto) {\r\n    // If this is the first address or marked as default, handle default logic\r\n    if (dto.isDefault) {\r\n      await this.clearDefaultAddress(userId);\r\n    }\r\n\r\n    // Check if this is the first address\r\n    const existingCount = await this.prisma.address.count({\r\n      where: { userId },\r\n    });\r\n    const isDefault = dto.isDefault || existingCount === 0;\r\n\r\n    return this.prisma.address.create({\r\n      data: {\r\n        ...dto,\r\n        userId,\r\n        isDefault,\r\n      },\r\n    });\r\n  }\r\n\r\n  async update(id: string, userId: string, dto: UpdateAddressDto) {\r\n    await this.findOne(id, userId);\r\n\r\n    // If setting as default, clear other defaults first\r\n    if (dto.isDefault) {\r\n      await this.clearDefaultAddress(userId);\r\n    }\r\n\r\n    return this.prisma.address.update({\r\n      where: { id },\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async remove(id: string, userId: string) {\r\n    const address = await this.findOne(id, userId);\r\n\r\n    await this.prisma.address.delete({ where: { id } });\r\n\r\n    // If deleted address was default, set another as default\r\n    if (address.isDefault) {\r\n      const nextAddress = await this.prisma.address.findFirst({\r\n        where: { userId },\r\n        orderBy: { createdAt: 'desc' },\r\n      });\r\n\r\n      if (nextAddress) {\r\n        await this.prisma.address.update({\r\n          where: { id: nextAddress.id },\r\n          data: { isDefault: true },\r\n        });\r\n      }\r\n    }\r\n\r\n    return { message: 'Đã xóa địa chỉ' };\r\n  }\r\n\r\n  async setDefault(id: string, userId: string) {\r\n    await this.findOne(id, userId);\r\n    await this.clearDefaultAddress(userId);\r\n\r\n    return this.prisma.address.update({\r\n      where: { id },\r\n      data: { isDefault: true },\r\n    });\r\n  }\r\n\r\n  private async clearDefaultAddress(userId: string) {\r\n    await this.prisma.address.updateMany({\r\n      where: { userId, isDefault: true },\r\n      data: { isDefault: false },\r\n    });\r\n  }\r\n}\r\n"],"names":["AddressesService","findAll","userId","prisma","address","findMany","where","orderBy","isDefault","createdAt","findOne","id","findFirst","NotFoundException","create","dto","clearDefaultAddress","existingCount","count","data","update","remove","delete","nextAddress","message","setDefault","updateMany"],"mappings":"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"}
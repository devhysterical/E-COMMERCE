{"version":3,"sources":["../../src/payment/payment.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport * as crypto from 'crypto';\r\n\r\ninterface MoMoPaymentRequest {\r\n  orderId: string;\r\n  amount: number;\r\n  orderInfo: string;\r\n  redirectUrl: string;\r\n  ipnUrl: string;\r\n}\r\n\r\ninterface MoMoPaymentResponse {\r\n  partnerCode: string;\r\n  orderId: string;\r\n  requestId: string;\r\n  amount: number;\r\n  responseTime: number;\r\n  message: string;\r\n  resultCode: number;\r\n  payUrl: string;\r\n  deeplink?: string;\r\n  qrCodeUrl?: string;\r\n}\r\n\r\n@Injectable()\r\nexport class PaymentService {\r\n  private readonly partnerCode: string;\r\n  private readonly accessKey: string;\r\n  private readonly secretKey: string;\r\n  private readonly apiEndpoint: string;\r\n\r\n  constructor() {\r\n    this.partnerCode = process.env.MOMO_PARTNER_CODE || '';\r\n    this.accessKey = process.env.MOMO_ACCESS_KEY || '';\r\n    this.secretKey = process.env.MOMO_SECRET_KEY || '';\r\n    this.apiEndpoint =\r\n      process.env.MOMO_API_ENDPOINT || 'https://test-payment.momo.vn';\r\n  }\r\n\r\n  async createMoMoPayment(\r\n    request: MoMoPaymentRequest,\r\n  ): Promise<MoMoPaymentResponse> {\r\n    const requestId = `${this.partnerCode}_${Date.now()}`;\r\n    const requestType = 'captureWallet';\r\n    const extraData = '';\r\n    const lang = 'vi';\r\n\r\n    // Tạo raw signature string theo thứ tự của MoMo\r\n    const rawSignature = `accessKey=${this.accessKey}&amount=${request.amount}&extraData=${extraData}&ipnUrl=${request.ipnUrl}&orderId=${request.orderId}&orderInfo=${request.orderInfo}&partnerCode=${this.partnerCode}&redirectUrl=${request.redirectUrl}&requestId=${requestId}&requestType=${requestType}`;\r\n\r\n    // Tạo signature bằng HMAC-SHA256\r\n    const signature = crypto\r\n      .createHmac('sha256', this.secretKey)\r\n      .update(rawSignature)\r\n      .digest('hex');\r\n\r\n    const requestBody = {\r\n      partnerCode: this.partnerCode,\r\n      accessKey: this.accessKey,\r\n      requestId,\r\n      amount: request.amount,\r\n      orderId: request.orderId,\r\n      orderInfo: request.orderInfo,\r\n      redirectUrl: request.redirectUrl,\r\n      ipnUrl: request.ipnUrl,\r\n      extraData,\r\n      requestType,\r\n      signature,\r\n      lang,\r\n    };\r\n\r\n    // Gọi API MoMo\r\n    const response = await fetch(`${this.apiEndpoint}/v2/gateway/api/create`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify(requestBody),\r\n    });\r\n\r\n    const result: MoMoPaymentResponse =\r\n      (await response.json()) as MoMoPaymentResponse;\r\n    return result;\r\n  }\r\n\r\n  verifyMoMoSignature(data: Record<string, string | number>): boolean {\r\n    const accessKey = String(data.accessKey ?? '');\r\n    const amount = String(data.amount ?? '');\r\n    const extraData = String(data.extraData ?? '');\r\n    const message = String(data.message ?? '');\r\n    const orderId = String(data.orderId ?? '');\r\n    const orderInfo = String(data.orderInfo ?? '');\r\n    const orderType = String(data.orderType ?? '');\r\n    const partnerCode = String(data.partnerCode ?? '');\r\n    const payType = String(data.payType ?? '');\r\n    const requestId = String(data.requestId ?? '');\r\n    const responseTime = String(data.responseTime ?? '');\r\n    const resultCode = String(data.resultCode ?? '');\r\n    const transId = String(data.transId ?? '');\r\n    const signature = String(data.signature ?? '');\r\n\r\n    const rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&message=${message}&orderId=${orderId}&orderInfo=${orderInfo}&orderType=${orderType}&partnerCode=${partnerCode}&payType=${payType}&requestId=${requestId}&responseTime=${responseTime}&resultCode=${resultCode}&transId=${transId}`;\r\n\r\n    const expectedSignature = crypto\r\n      .createHmac('sha256', this.secretKey)\r\n      .update(rawSignature)\r\n      .digest('hex');\r\n\r\n    return signature === expectedSignature;\r\n  }\r\n}\r\n"],"names":["PaymentService","createMoMoPayment","request","requestId","partnerCode","Date","now","requestType","extraData","lang","rawSignature","accessKey","amount","ipnUrl","orderId","orderInfo","redirectUrl","signature","crypto","createHmac","secretKey","update","digest","requestBody","response","fetch","apiEndpoint","method","headers","body","JSON","stringify","result","json","verifyMoMoSignature","data","String","message","orderType","payType","responseTime","resultCode","transId","expectedSignature","process","env","MOMO_PARTNER_CODE","MOMO_ACCESS_KEY","MOMO_SECRET_KEY","MOMO_API_ENDPOINT"],"mappings":"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"}
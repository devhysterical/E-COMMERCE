{"version":3,"sources":["../../src/payment/payment.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  Body,\r\n  Get,\r\n  Query,\r\n  Res,\r\n  UseGuards,\r\n  Request,\r\n} from '@nestjs/common';\r\nimport type { Response } from 'express';\r\nimport { PaymentService } from './payment.service';\r\nimport { OrdersService } from '../orders/orders.service';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\n\r\ninterface CreateMoMoPaymentDto {\r\n  orderId: string;\r\n}\r\n\r\n@Controller('payment')\r\nexport class PaymentController {\r\n  constructor(\r\n    private readonly paymentService: PaymentService,\r\n    private readonly ordersService: OrdersService,\r\n  ) {}\r\n\r\n  @Post('momo/create')\r\n  @UseGuards(JwtAuthGuard)\r\n  async createMoMoPayment(\r\n    @Body() dto: CreateMoMoPaymentDto,\r\n    @Request() req: { user: { userId: string } },\r\n  ) {\r\n    const order = await this.ordersService.findOne(\r\n      dto.orderId,\r\n      req.user.userId,\r\n    );\r\n\r\n    if (!order) {\r\n      return { success: false, message: 'Đơn hàng không tồn tại' };\r\n    }\r\n\r\n    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\r\n    const backendUrl = process.env.BACKEND_URL || 'http://localhost:4000';\r\n\r\n    const result = await this.paymentService.createMoMoPayment({\r\n      orderId: dto.orderId,\r\n      amount: order.totalAmount,\r\n      orderInfo: `Thanh toán đơn hàng #${dto.orderId.slice(0, 8)}`,\r\n      redirectUrl: `${frontendUrl}/orders?payment=success`,\r\n      ipnUrl: `${backendUrl}/payment/momo/callback`,\r\n    });\r\n\r\n    if (result.resultCode === 0) {\r\n      return {\r\n        success: true,\r\n        payUrl: result.payUrl,\r\n        deeplink: result.deeplink,\r\n        qrCodeUrl: result.qrCodeUrl,\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: false,\r\n      message: result.message,\r\n    };\r\n  }\r\n\r\n  @Post('momo/callback')\r\n  async handleMoMoCallback(@Body() data: Record<string, string | number>) {\r\n    // Verify signature\r\n    const isValid = this.paymentService.verifyMoMoSignature(data);\r\n\r\n    if (!isValid) {\r\n      return { resultCode: 1, message: 'Invalid signature' };\r\n    }\r\n\r\n    const orderId = String(data.orderId);\r\n    const resultCode = Number(data.resultCode);\r\n    const transId = String(data.transId);\r\n\r\n    if (resultCode === 0) {\r\n      // Thanh toán thành công\r\n      await this.ordersService.updatePaymentStatus(\r\n        orderId,\r\n        'COMPLETED',\r\n        transId,\r\n      );\r\n    } else {\r\n      // Thanh toán thất bại\r\n      await this.ordersService.updatePaymentStatus(orderId, 'FAILED', null);\r\n    }\r\n\r\n    return { resultCode: 0, message: 'OK' };\r\n  }\r\n\r\n  @Get('momo/return')\r\n  handleMoMoReturn(\r\n    @Query('orderId') orderId: string,\r\n    @Query('resultCode') resultCode: string,\r\n    @Res() res: Response,\r\n  ) {\r\n    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\r\n\r\n    if (resultCode === '0') {\r\n      return res.redirect(`${frontendUrl}/orders?payment=success`);\r\n    }\r\n\r\n    return res.redirect(`${frontendUrl}/orders?payment=failed`);\r\n  }\r\n}\r\n"],"names":["PaymentController","createMoMoPayment","dto","req","order","ordersService","findOne","orderId","user","userId","success","message","frontendUrl","process","env","FRONTEND_URL","backendUrl","BACKEND_URL","result","paymentService","amount","totalAmount","orderInfo","slice","redirectUrl","ipnUrl","resultCode","payUrl","deeplink","qrCodeUrl","handleMoMoCallback","data","isValid","verifyMoMoSignature","String","Number","transId","updatePaymentStatus","handleMoMoReturn","res","redirect"],"mappings":";;;;+BAoBaA;;;eAAAA;;;wBAXN;gCAEwB;+BACD;8BACD;;;;;;;;;;;;;;;AAOtB,IAAA,AAAMA,oBAAN,MAAMA;IAMX,MAEMC,kBACJ,AAAQC,GAAyB,EACjC,AAAWC,GAAiC,EAC5C;QACA,MAAMC,QAAQ,MAAM,IAAI,CAACC,aAAa,CAACC,OAAO,CAC5CJ,IAAIK,OAAO,EACXJ,IAAIK,IAAI,CAACC,MAAM;QAGjB,IAAI,CAACL,OAAO;YACV,OAAO;gBAAEM,SAAS;gBAAOC,SAAS;YAAyB;QAC7D;QAEA,MAAMC,cAAcC,QAAQC,GAAG,CAACC,YAAY,IAAI;QAChD,MAAMC,aAAaH,QAAQC,GAAG,CAACG,WAAW,IAAI;QAE9C,MAAMC,SAAS,MAAM,IAAI,CAACC,cAAc,CAAClB,iBAAiB,CAAC;YACzDM,SAASL,IAAIK,OAAO;YACpBa,QAAQhB,MAAMiB,WAAW;YACzBC,WAAW,CAAC,qBAAqB,EAAEpB,IAAIK,OAAO,CAACgB,KAAK,CAAC,GAAG,IAAI;YAC5DC,aAAa,GAAGZ,YAAY,uBAAuB,CAAC;YACpDa,QAAQ,GAAGT,WAAW,sBAAsB,CAAC;QAC/C;QAEA,IAAIE,OAAOQ,UAAU,KAAK,GAAG;YAC3B,OAAO;gBACLhB,SAAS;gBACTiB,QAAQT,OAAOS,MAAM;gBACrBC,UAAUV,OAAOU,QAAQ;gBACzBC,WAAWX,OAAOW,SAAS;YAC7B;QACF;QAEA,OAAO;YACLnB,SAAS;YACTC,SAASO,OAAOP,OAAO;QACzB;IACF;IAEA,MACMmB,mBAAmB,AAAQC,IAAqC,EAAE;QACtE,mBAAmB;QACnB,MAAMC,UAAU,IAAI,CAACb,cAAc,CAACc,mBAAmB,CAACF;QAExD,IAAI,CAACC,SAAS;YACZ,OAAO;gBAAEN,YAAY;gBAAGf,SAAS;YAAoB;QACvD;QAEA,MAAMJ,UAAU2B,OAAOH,KAAKxB,OAAO;QACnC,MAAMmB,aAAaS,OAAOJ,KAAKL,UAAU;QACzC,MAAMU,UAAUF,OAAOH,KAAKK,OAAO;QAEnC,IAAIV,eAAe,GAAG;YACpB,wBAAwB;YACxB,MAAM,IAAI,CAACrB,aAAa,CAACgC,mBAAmB,CAC1C9B,SACA,aACA6B;QAEJ,OAAO;YACL,sBAAsB;YACtB,MAAM,IAAI,CAAC/B,aAAa,CAACgC,mBAAmB,CAAC9B,SAAS,UAAU;QAClE;QAEA,OAAO;YAAEmB,YAAY;YAAGf,SAAS;QAAK;IACxC;IAGA2B,iBACE,AAAkB/B,OAAe,EACjC,AAAqBmB,UAAkB,EACvC,AAAOa,GAAa,EACpB;QACA,MAAM3B,cAAcC,QAAQC,GAAG,CAACC,YAAY,IAAI;QAEhD,IAAIW,eAAe,KAAK;YACtB,OAAOa,IAAIC,QAAQ,CAAC,GAAG5B,YAAY,uBAAuB,CAAC;QAC7D;QAEA,OAAO2B,IAAIC,QAAQ,CAAC,GAAG5B,YAAY,sBAAsB,CAAC;IAC5D;IAvFA,YACE,AAAiBO,cAA8B,EAC/C,AAAiBd,aAA4B,CAC7C;aAFiBc,iBAAAA;aACAd,gBAAAA;IAChB;AAqFL"}
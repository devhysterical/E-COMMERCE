{"version":3,"sources":["../../src/products/products.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateProductDto, UpdateProductDto } from './dto/product.dto';\r\n\r\n@Injectable()\r\nexport class ProductsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async create(dto: CreateProductDto) {\r\n    return this.prisma.product.create({\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async findAll(\r\n    categoryId?: string,\r\n    search?: string,\r\n    page = 1,\r\n    limit = 12,\r\n    sortBy: 'price' | 'name' | 'createdAt' = 'createdAt',\r\n    sortOrder: 'asc' | 'desc' = 'desc',\r\n    minPrice?: number,\r\n    maxPrice?: number,\r\n  ) {\r\n    const skip = (page - 1) * limit;\r\n    const where = {\r\n      deletedAt: null,\r\n      ...(categoryId && { categoryId }),\r\n      ...(search && {\r\n        name: { contains: search, mode: 'insensitive' as const },\r\n      }),\r\n      ...((minPrice !== undefined || maxPrice !== undefined) && {\r\n        price: {\r\n          ...(minPrice !== undefined && { gte: minPrice }),\r\n          ...(maxPrice !== undefined && { lte: maxPrice }),\r\n        },\r\n      }),\r\n    };\r\n\r\n    const [products, total] = await Promise.all([\r\n      this.prisma.product.findMany({\r\n        where,\r\n        include: { category: true, images: { orderBy: { sortOrder: 'asc' } } },\r\n        skip,\r\n        take: limit,\r\n        orderBy: { [sortBy]: sortOrder },\r\n      }),\r\n      this.prisma.product.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      data: products,\r\n      meta: {\r\n        total,\r\n        page,\r\n        limit,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  async findOne(id: string) {\r\n    const product = await this.prisma.product.findFirst({\r\n      where: { id, deletedAt: null },\r\n      include: {\r\n        category: true,\r\n        reviews: true,\r\n        images: { orderBy: { sortOrder: 'asc' } },\r\n      },\r\n    });\r\n    if (!product) {\r\n      throw new NotFoundException('Không tìm thấy sản phẩm');\r\n    }\r\n    return product;\r\n  }\r\n\r\n  async update(id: string, dto: UpdateProductDto) {\r\n    await this.findOne(id);\r\n    return this.prisma.product.update({\r\n      where: { id },\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async remove(id: string) {\r\n    await this.findOne(id);\r\n    return this.prisma.product.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date() },\r\n    });\r\n  }\r\n\r\n  // ===== Product Images Management =====\r\n\r\n  async addImage(productId: string, imageUrl: string, isPrimary = false) {\r\n    await this.findOne(productId);\r\n\r\n    // Nếu đặt làm ảnh chính, bỏ primary của các ảnh khác\r\n    if (isPrimary) {\r\n      await this.prisma.productImage.updateMany({\r\n        where: { productId },\r\n        data: { isPrimary: false },\r\n      });\r\n    }\r\n\r\n    // Lấy sortOrder tiếp theo\r\n    const lastImage = await this.prisma.productImage.findFirst({\r\n      where: { productId },\r\n      orderBy: { sortOrder: 'desc' },\r\n    });\r\n    const sortOrder = lastImage ? lastImage.sortOrder + 1 : 0;\r\n\r\n    return this.prisma.productImage.create({\r\n      data: {\r\n        productId,\r\n        imageUrl,\r\n        isPrimary,\r\n        sortOrder,\r\n      },\r\n    });\r\n  }\r\n\r\n  async removeImage(productId: string, imageId: string) {\r\n    const image = await this.prisma.productImage.findFirst({\r\n      where: { id: imageId, productId },\r\n    });\r\n\r\n    if (!image) {\r\n      throw new NotFoundException('Ảnh không tồn tại');\r\n    }\r\n\r\n    await this.prisma.productImage.delete({\r\n      where: { id: imageId },\r\n    });\r\n\r\n    return { message: 'Đã xóa ảnh' };\r\n  }\r\n\r\n  async setPrimaryImage(productId: string, imageId: string) {\r\n    const image = await this.prisma.productImage.findFirst({\r\n      where: { id: imageId, productId },\r\n    });\r\n\r\n    if (!image) {\r\n      throw new NotFoundException('Ảnh không tồn tại');\r\n    }\r\n\r\n    // Bỏ primary của tất cả ảnh\r\n    await this.prisma.productImage.updateMany({\r\n      where: { productId },\r\n      data: { isPrimary: false },\r\n    });\r\n\r\n    // Đặt ảnh này làm primary\r\n    return this.prisma.productImage.update({\r\n      where: { id: imageId },\r\n      data: { isPrimary: true },\r\n    });\r\n  }\r\n\r\n  async getImages(productId: string) {\r\n    await this.findOne(productId);\r\n    return this.prisma.productImage.findMany({\r\n      where: { productId },\r\n      orderBy: { sortOrder: 'asc' },\r\n    });\r\n  }\r\n}\r\n"],"names":["ProductsService","create","dto","prisma","product","data","findAll","categoryId","search","page","limit","sortBy","sortOrder","minPrice","maxPrice","skip","where","deletedAt","name","contains","mode","undefined","price","gte","lte","products","total","Promise","all","findMany","include","category","images","orderBy","take","count","meta","totalPages","Math","ceil","findOne","id","findFirst","reviews","NotFoundException","update","remove","Date","addImage","productId","imageUrl","isPrimary","productImage","updateMany","lastImage","removeImage","imageId","image","delete","message","setPrimaryImage","getImages"],"mappings":"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"}
{"version":3,"sources":["../../src/products/products.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateProductDto, UpdateProductDto } from './dto/product.dto';\r\n\r\n@Injectable()\r\nexport class ProductsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async create(dto: CreateProductDto) {\r\n    return this.prisma.product.create({\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async findAll(\r\n    categoryId?: string,\r\n    search?: string,\r\n    page = 1,\r\n    limit = 12,\r\n    sortBy: 'price' | 'name' | 'createdAt' = 'createdAt',\r\n    sortOrder: 'asc' | 'desc' = 'desc',\r\n    minPrice?: number,\r\n    maxPrice?: number,\r\n  ) {\r\n    const skip = (page - 1) * limit;\r\n    const where = {\r\n      deletedAt: null,\r\n      ...(categoryId && { categoryId }),\r\n      ...(search && {\r\n        name: { contains: search, mode: 'insensitive' as const },\r\n      }),\r\n      ...((minPrice !== undefined || maxPrice !== undefined) && {\r\n        price: {\r\n          ...(minPrice !== undefined && { gte: minPrice }),\r\n          ...(maxPrice !== undefined && { lte: maxPrice }),\r\n        },\r\n      }),\r\n    };\r\n\r\n    const [products, total] = await Promise.all([\r\n      this.prisma.product.findMany({\r\n        where,\r\n        include: { category: true, images: { orderBy: { sortOrder: 'asc' } } },\r\n        skip,\r\n        take: limit,\r\n        orderBy: { [sortBy]: sortOrder },\r\n      }),\r\n      this.prisma.product.count({ where }),\r\n    ]);\r\n\r\n    return {\r\n      data: products,\r\n      meta: {\r\n        total,\r\n        page,\r\n        limit,\r\n        totalPages: Math.ceil(total / limit),\r\n      },\r\n    };\r\n  }\r\n\r\n  // Search Autocomplete - gợi ý sản phẩm khi gõ\r\n  async searchSuggest(query: string, limit: number = 5) {\r\n    if (!query.trim()) {\r\n      return [];\r\n    }\r\n\r\n    return this.prisma.product.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        name: { contains: query, mode: 'insensitive' },\r\n      },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        price: true,\r\n        imageUrl: true,\r\n      },\r\n      take: limit,\r\n      orderBy: { name: 'asc' },\r\n    });\r\n  }\r\n\r\n  // Related Products - sản phẩm cùng category (trừ sản phẩm hiện tại)\r\n  async getRelatedProducts(productId: string, limit: number = 4) {\r\n    const product = await this.prisma.product.findUnique({\r\n      where: { id: productId },\r\n      select: { categoryId: true },\r\n    });\r\n\r\n    if (!product) {\r\n      return [];\r\n    }\r\n\r\n    return this.prisma.product.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        categoryId: product.categoryId,\r\n        id: { not: productId },\r\n      },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        price: true,\r\n        imageUrl: true,\r\n        category: { select: { id: true, name: true } },\r\n      },\r\n      take: limit,\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Low Stock Products - sản phẩm tồn kho thấp\r\n  async getLowStockProducts(threshold: number = 10) {\r\n    const products = await this.prisma.product.findMany({\r\n      where: {\r\n        deletedAt: null,\r\n        stock: { lte: threshold },\r\n      },\r\n      select: {\r\n        id: true,\r\n        name: true,\r\n        price: true,\r\n        stock: true,\r\n        imageUrl: true,\r\n        category: { select: { id: true, name: true } },\r\n      },\r\n      orderBy: { stock: 'asc' },\r\n    });\r\n\r\n    return {\r\n      products,\r\n      total: products.length,\r\n      threshold,\r\n    };\r\n  }\r\n\r\n  async findOne(id: string) {\r\n    const product = await this.prisma.product.findFirst({\r\n      where: { id, deletedAt: null },\r\n      include: {\r\n        category: true,\r\n        reviews: true,\r\n        images: { orderBy: { sortOrder: 'asc' } },\r\n      },\r\n    });\r\n    if (!product) {\r\n      throw new NotFoundException('Không tìm thấy sản phẩm');\r\n    }\r\n    return product;\r\n  }\r\n\r\n  async update(id: string, dto: UpdateProductDto) {\r\n    await this.findOne(id);\r\n    return this.prisma.product.update({\r\n      where: { id },\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async remove(id: string) {\r\n    await this.findOne(id);\r\n    return this.prisma.product.update({\r\n      where: { id },\r\n      data: { deletedAt: new Date() },\r\n    });\r\n  }\r\n\r\n  // ===== Product Images Management =====\r\n\r\n  async addImage(productId: string, imageUrl: string, isPrimary = false) {\r\n    await this.findOne(productId);\r\n\r\n    // Nếu đặt làm ảnh chính, bỏ primary của các ảnh khác\r\n    if (isPrimary) {\r\n      await this.prisma.productImage.updateMany({\r\n        where: { productId },\r\n        data: { isPrimary: false },\r\n      });\r\n    }\r\n\r\n    // Lấy sortOrder tiếp theo\r\n    const lastImage = await this.prisma.productImage.findFirst({\r\n      where: { productId },\r\n      orderBy: { sortOrder: 'desc' },\r\n    });\r\n    const sortOrder = lastImage ? lastImage.sortOrder + 1 : 0;\r\n\r\n    return this.prisma.productImage.create({\r\n      data: {\r\n        productId,\r\n        imageUrl,\r\n        isPrimary,\r\n        sortOrder,\r\n      },\r\n    });\r\n  }\r\n\r\n  async removeImage(productId: string, imageId: string) {\r\n    const image = await this.prisma.productImage.findFirst({\r\n      where: { id: imageId, productId },\r\n    });\r\n\r\n    if (!image) {\r\n      throw new NotFoundException('Ảnh không tồn tại');\r\n    }\r\n\r\n    await this.prisma.productImage.delete({\r\n      where: { id: imageId },\r\n    });\r\n\r\n    return { message: 'Đã xóa ảnh' };\r\n  }\r\n\r\n  async setPrimaryImage(productId: string, imageId: string) {\r\n    const image = await this.prisma.productImage.findFirst({\r\n      where: { id: imageId, productId },\r\n    });\r\n\r\n    if (!image) {\r\n      throw new NotFoundException('Ảnh không tồn tại');\r\n    }\r\n\r\n    // Bỏ primary của tất cả ảnh\r\n    await this.prisma.productImage.updateMany({\r\n      where: { productId },\r\n      data: { isPrimary: false },\r\n    });\r\n\r\n    // Đặt ảnh này làm primary\r\n    return this.prisma.productImage.update({\r\n      where: { id: imageId },\r\n      data: { isPrimary: true },\r\n    });\r\n  }\r\n\r\n  async getImages(productId: string) {\r\n    await this.findOne(productId);\r\n    return this.prisma.productImage.findMany({\r\n      where: { productId },\r\n      orderBy: { sortOrder: 'asc' },\r\n    });\r\n  }\r\n}\r\n"],"names":["ProductsService","create","dto","prisma","product","data","findAll","categoryId","search","page","limit","sortBy","sortOrder","minPrice","maxPrice","skip","where","deletedAt","name","contains","mode","undefined","price","gte","lte","products","total","Promise","all","findMany","include","category","images","orderBy","take","count","meta","totalPages","Math","ceil","searchSuggest","query","trim","select","id","imageUrl","getRelatedProducts","productId","findUnique","not","createdAt","getLowStockProducts","threshold","stock","length","findOne","findFirst","reviews","NotFoundException","update","remove","Date","addImage","isPrimary","productImage","updateMany","lastImage","removeImage","imageId","image","delete","message","setPrimaryImage","getImages"],"mappings":"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"}
{"version":3,"sources":["../../src/reports/reports.service.ts"],"sourcesContent":["import { Injectable, StreamableFile } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport * as ExcelJS from 'exceljs';\r\n\r\n@Injectable()\r\nexport class ReportsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // Export Orders to Excel\r\n  async exportOrders(\r\n    startDate?: Date,\r\n    endDate?: Date,\r\n  ): Promise<StreamableFile> {\r\n    const where: Record<string, unknown> = {};\r\n\r\n    if (startDate || endDate) {\r\n      where.createdAt = {};\r\n      if (startDate) {\r\n        (where.createdAt as Record<string, unknown>).gte = startDate;\r\n      }\r\n      if (endDate) {\r\n        (where.createdAt as Record<string, unknown>).lte = endDate;\r\n      }\r\n    }\r\n\r\n    const orders = await this.prisma.order.findMany({\r\n      where,\r\n      include: {\r\n        user: { select: { fullName: true, email: true } },\r\n        orderItems: {\r\n          include: { product: { select: { name: true } } },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    const workbook = new ExcelJS.Workbook();\r\n    workbook.creator = 'E-Commerce Admin';\r\n    workbook.created = new Date();\r\n\r\n    const sheet = workbook.addWorksheet('Đơn hàng');\r\n\r\n    // Headers\r\n    sheet.columns = [\r\n      { header: 'Mã đơn', key: 'id', width: 36 },\r\n      { header: 'Khách hàng', key: 'customer', width: 25 },\r\n      { header: 'Email', key: 'email', width: 30 },\r\n      { header: 'Sản phẩm', key: 'products', width: 40 },\r\n      { header: 'Tổng tiền', key: 'total', width: 15 },\r\n      { header: 'Giảm giá', key: 'discount', width: 12 },\r\n      { header: 'Trạng thái', key: 'status', width: 15 },\r\n      { header: 'Thanh toán', key: 'payment', width: 12 },\r\n      { header: 'Địa chỉ', key: 'address', width: 35 },\r\n      { header: 'Ngày đặt', key: 'date', width: 18 },\r\n    ];\r\n\r\n    // Style header\r\n    sheet.getRow(1).font = { bold: true };\r\n    sheet.getRow(1).fill = {\r\n      type: 'pattern',\r\n      pattern: 'solid',\r\n      fgColor: { argb: 'FF4F46E5' },\r\n    };\r\n    sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\r\n\r\n    // Data rows\r\n    const statusLabels: Record<string, string> = {\r\n      PENDING: 'Chờ xử lý',\r\n      PROCESSING: 'Đang xử lý',\r\n      SHIPPED: 'Đang giao',\r\n      DELIVERED: 'Đã giao',\r\n      CANCELLED: 'Đã hủy',\r\n    };\r\n\r\n    orders.forEach((order) => {\r\n      const products = order.orderItems\r\n        .map((item) => `${item.product.name} x${item.quantity}`)\r\n        .join(', ');\r\n\r\n      sheet.addRow({\r\n        id: order.id,\r\n        customer: order.user?.fullName || 'N/A',\r\n        email: order.user?.email || 'N/A',\r\n        products,\r\n        total: order.totalAmount,\r\n        discount: order.discountAmount || 0,\r\n        status: statusLabels[order.status] || order.status,\r\n        payment: order.paymentMethod,\r\n        address: order.address,\r\n        date: new Date(order.createdAt).toLocaleDateString('vi-VN'),\r\n      });\r\n    });\r\n\r\n    // Auto-fit và thêm border\r\n    sheet.eachRow((row, rowNumber) => {\r\n      row.eachCell((cell) => {\r\n        cell.border = {\r\n          top: { style: 'thin' },\r\n          left: { style: 'thin' },\r\n          bottom: { style: 'thin' },\r\n          right: { style: 'thin' },\r\n        };\r\n        if (rowNumber > 1) {\r\n          cell.alignment = { vertical: 'middle', wrapText: true };\r\n        }\r\n      });\r\n    });\r\n\r\n    const buffer = await workbook.xlsx.writeBuffer();\r\n    return new StreamableFile(Buffer.from(buffer), {\r\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n      disposition: `attachment; filename=\"orders_${Date.now()}.xlsx\"`,\r\n    });\r\n  }\r\n\r\n  // Export Products Inventory to Excel\r\n  async exportProducts(): Promise<StreamableFile> {\r\n    const products = await this.prisma.product.findMany({\r\n      where: { deletedAt: null },\r\n      include: { category: { select: { name: true } } },\r\n      orderBy: { name: 'asc' },\r\n    });\r\n\r\n    const workbook = new ExcelJS.Workbook();\r\n    workbook.creator = 'E-Commerce Admin';\r\n    workbook.created = new Date();\r\n\r\n    const sheet = workbook.addWorksheet('Tồn kho sản phẩm');\r\n\r\n    // Headers\r\n    sheet.columns = [\r\n      { header: 'Mã sản phẩm', key: 'id', width: 36 },\r\n      { header: 'Tên sản phẩm', key: 'name', width: 40 },\r\n      { header: 'Danh mục', key: 'category', width: 20 },\r\n      { header: 'Giá (đ)', key: 'price', width: 15 },\r\n      { header: 'Tồn kho', key: 'stock', width: 12 },\r\n      { header: 'Trạng thái', key: 'status', width: 15 },\r\n      { header: 'Ngày tạo', key: 'createdAt', width: 18 },\r\n    ];\r\n\r\n    // Style header\r\n    sheet.getRow(1).fill = {\r\n      type: 'pattern',\r\n      pattern: 'solid',\r\n      fgColor: { argb: 'FF4F46E5' },\r\n    };\r\n    sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\r\n\r\n    // Data rows\r\n    products.forEach((product) => {\r\n      const row = sheet.addRow({\r\n        id: product.id,\r\n        name: product.name,\r\n        category: product.category?.name || 'N/A',\r\n        price: product.price,\r\n        stock: product.stock,\r\n        status:\r\n          product.stock === 0\r\n            ? 'Hết hàng'\r\n            : product.stock <= 10\r\n              ? 'Sắp hết'\r\n              : 'Còn hàng',\r\n        createdAt: new Date(product.createdAt).toLocaleDateString('vi-VN'),\r\n      });\r\n\r\n      // Highlight low stock\r\n      if (product.stock <= 10) {\r\n        row.getCell('stock').fill = {\r\n          type: 'pattern',\r\n          pattern: 'solid',\r\n          fgColor: { argb: product.stock === 0 ? 'FFFECACA' : 'FFFEF3C7' },\r\n        };\r\n      }\r\n    });\r\n\r\n    // Add borders\r\n    sheet.eachRow((row) => {\r\n      row.eachCell((cell) => {\r\n        cell.border = {\r\n          top: { style: 'thin' },\r\n          left: { style: 'thin' },\r\n          bottom: { style: 'thin' },\r\n          right: { style: 'thin' },\r\n        };\r\n      });\r\n    });\r\n\r\n    const buffer = await workbook.xlsx.writeBuffer();\r\n    return new StreamableFile(Buffer.from(buffer), {\r\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n      disposition: `attachment; filename=\"products_inventory_${Date.now()}.xlsx\"`,\r\n    });\r\n  }\r\n}\r\n"],"names":["ReportsService","exportOrders","startDate","endDate","where","createdAt","gte","lte","orders","prisma","order","findMany","include","user","select","fullName","email","orderItems","product","name","orderBy","workbook","ExcelJS","Workbook","creator","created","Date","sheet","addWorksheet","columns","header","key","width","getRow","font","bold","fill","type","pattern","fgColor","argb","color","statusLabels","PENDING","PROCESSING","SHIPPED","DELIVERED","CANCELLED","forEach","products","map","item","quantity","join","addRow","id","customer","total","totalAmount","discount","discountAmount","status","payment","paymentMethod","address","date","toLocaleDateString","eachRow","row","rowNumber","eachCell","cell","border","top","style","left","bottom","right","alignment","vertical","wrapText","buffer","xlsx","writeBuffer","StreamableFile","Buffer","from","disposition","now","exportProducts","deletedAt","category","price","stock","getCell"],"mappings":"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"}
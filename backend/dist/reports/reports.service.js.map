{"version":3,"sources":["../../src/reports/reports.service.ts"],"sourcesContent":["import { Injectable, StreamableFile } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport * as ExcelJS from 'exceljs';\r\n\r\n@Injectable()\r\nexport class ReportsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // Export Orders to Excel\r\n  async exportOrders(\r\n    startDate?: Date,\r\n    endDate?: Date,\r\n  ): Promise<StreamableFile> {\r\n    const where: Record<string, unknown> = {};\r\n\r\n    if (startDate || endDate) {\r\n      where.createdAt = {};\r\n      if (startDate) {\r\n        (where.createdAt as Record<string, unknown>).gte = startDate;\r\n      }\r\n      if (endDate) {\r\n        (where.createdAt as Record<string, unknown>).lte = endDate;\r\n      }\r\n    }\r\n\r\n    const orders = await this.prisma.order.findMany({\r\n      where,\r\n      include: {\r\n        user: { select: { fullName: true, email: true } },\r\n        orderItems: {\r\n          include: { product: { select: { name: true } } },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    const workbook = new ExcelJS.Workbook();\r\n    workbook.creator = 'E-Commerce Admin';\r\n    workbook.created = new Date();\r\n\r\n    const sheet = workbook.addWorksheet('Đơn hàng');\r\n\r\n    // Headers\r\n    sheet.columns = [\r\n      { header: 'Mã đơn', key: 'id', width: 36 },\r\n      { header: 'Khách hàng', key: 'customer', width: 25 },\r\n      { header: 'Email', key: 'email', width: 30 },\r\n      { header: 'Sản phẩm', key: 'products', width: 40 },\r\n      { header: 'Tổng tiền', key: 'total', width: 15 },\r\n      { header: 'Giảm giá', key: 'discount', width: 12 },\r\n      { header: 'Trạng thái', key: 'status', width: 15 },\r\n      { header: 'Thanh toán', key: 'payment', width: 12 },\r\n      { header: 'Địa chỉ', key: 'address', width: 35 },\r\n      { header: 'Ngày đặt', key: 'date', width: 18 },\r\n    ];\r\n\r\n    // Style header\r\n    sheet.getRow(1).font = { bold: true };\r\n    sheet.getRow(1).fill = {\r\n      type: 'pattern',\r\n      pattern: 'solid',\r\n      fgColor: { argb: 'FF4F46E5' },\r\n    };\r\n    sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\r\n\r\n    // Data rows\r\n    const statusLabels: Record<string, string> = {\r\n      PENDING: 'Chờ xử lý',\r\n      PROCESSING: 'Đang xử lý',\r\n      SHIPPED: 'Đang giao',\r\n      DELIVERED: 'Đã giao',\r\n      CANCELLED: 'Đã hủy',\r\n    };\r\n\r\n    orders.forEach((order) => {\r\n      const products = order.orderItems\r\n        .map((item) => `${item.product.name} x${item.quantity}`)\r\n        .join(', ');\r\n\r\n      sheet.addRow({\r\n        id: order.id,\r\n        customer: order.user?.fullName || 'N/A',\r\n        email: order.user?.email || 'N/A',\r\n        products,\r\n        total: order.totalAmount,\r\n        discount: order.discountAmount || 0,\r\n        status: statusLabels[order.status] || order.status,\r\n        payment: order.paymentMethod,\r\n        address: order.address,\r\n        date: new Date(order.createdAt).toLocaleDateString('vi-VN'),\r\n      });\r\n    });\r\n\r\n    // Auto-fit và thêm border\r\n    sheet.eachRow((row, rowNumber) => {\r\n      row.eachCell((cell) => {\r\n        cell.border = {\r\n          top: { style: 'thin' },\r\n          left: { style: 'thin' },\r\n          bottom: { style: 'thin' },\r\n          right: { style: 'thin' },\r\n        };\r\n        if (rowNumber > 1) {\r\n          cell.alignment = { vertical: 'middle', wrapText: true };\r\n        }\r\n      });\r\n    });\r\n\r\n    const buffer = await workbook.xlsx.writeBuffer();\r\n    return new StreamableFile(Buffer.from(buffer), {\r\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n      disposition: `attachment; filename=\"orders_${Date.now()}.xlsx\"`,\r\n    });\r\n  }\r\n\r\n  // Export Products Inventory to Excel\r\n  async exportProducts(): Promise<StreamableFile> {\r\n    const products = await this.prisma.product.findMany({\r\n      where: { deletedAt: null },\r\n      include: { category: { select: { name: true } } },\r\n      orderBy: { name: 'asc' },\r\n    });\r\n\r\n    const workbook = new ExcelJS.Workbook();\r\n    workbook.creator = 'E-Commerce Admin';\r\n    workbook.created = new Date();\r\n\r\n    const sheet = workbook.addWorksheet('Tồn kho sản phẩm');\r\n\r\n    // Headers\r\n    sheet.columns = [\r\n      { header: 'Mã sản phẩm', key: 'id', width: 36 },\r\n      { header: 'Tên sản phẩm', key: 'name', width: 40 },\r\n      { header: 'Danh mục', key: 'category', width: 20 },\r\n      { header: 'Giá (đ)', key: 'price', width: 15 },\r\n      { header: 'Tồn kho', key: 'stock', width: 12 },\r\n      { header: 'Trạng thái', key: 'status', width: 15 },\r\n      { header: 'Ngày tạo', key: 'createdAt', width: 18 },\r\n    ];\r\n\r\n    // Style header\r\n    sheet.getRow(1).fill = {\r\n      type: 'pattern',\r\n      pattern: 'solid',\r\n      fgColor: { argb: 'FF4F46E5' },\r\n    };\r\n    sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };\r\n\r\n    // Data rows\r\n    products.forEach((product) => {\r\n      const row = sheet.addRow({\r\n        id: product.id,\r\n        name: product.name,\r\n        category: product.category?.name || 'N/A',\r\n        price: product.price,\r\n        stock: product.stock,\r\n        status:\r\n          product.stock === 0\r\n            ? 'Hết hàng'\r\n            : product.stock <= 10\r\n              ? 'Sắp hết'\r\n              : 'Còn hàng',\r\n        createdAt: new Date(product.createdAt).toLocaleDateString('vi-VN'),\r\n      });\r\n\r\n      // Highlight low stock\r\n      if (product.stock <= 10) {\r\n        row.getCell('stock').fill = {\r\n          type: 'pattern',\r\n          pattern: 'solid',\r\n          fgColor: { argb: product.stock === 0 ? 'FFFECACA' : 'FFFEF3C7' },\r\n        };\r\n      }\r\n    });\r\n\r\n    // Add borders\r\n    sheet.eachRow((row) => {\r\n      row.eachCell((cell) => {\r\n        cell.border = {\r\n          top: { style: 'thin' },\r\n          left: { style: 'thin' },\r\n          bottom: { style: 'thin' },\r\n          right: { style: 'thin' },\r\n        };\r\n      });\r\n    });\r\n\r\n    const buffer = await workbook.xlsx.writeBuffer();\r\n    return new StreamableFile(Buffer.from(buffer), {\r\n      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\r\n      disposition: `attachment; filename=\"products_inventory_${Date.now()}.xlsx\"`,\r\n    });\r\n  }\r\n\r\n  // ===== ANALYTICS v2 =====\r\n\r\n  private getDateRange(period: string): Date {\r\n    const now = new Date();\r\n    switch (period) {\r\n      case '7d':\r\n        return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\r\n      case '90d':\r\n        return new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);\r\n      case '30d':\r\n      default:\r\n        return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n    }\r\n  }\r\n\r\n  async getRevenueChart(period: string = '30d') {\r\n    const startDate = this.getDateRange(period);\r\n\r\n    const orders = await this.prisma.order.findMany({\r\n      where: {\r\n        createdAt: { gte: startDate },\r\n        status: { not: 'CANCELLED' },\r\n      },\r\n      select: {\r\n        totalAmount: true,\r\n        discountAmount: true,\r\n        shippingFee: true,\r\n        createdAt: true,\r\n      },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n\r\n    // Group by date\r\n    const grouped = new Map<string, number>();\r\n    orders.forEach((order) => {\r\n      const dateKey = order.createdAt.toISOString().split('T')[0];\r\n      const revenue = order.totalAmount - order.discountAmount;\r\n      grouped.set(dateKey, (grouped.get(dateKey) || 0) + revenue);\r\n    });\r\n\r\n    return Array.from(grouped.entries()).map(([date, revenue]) => ({\r\n      date,\r\n      revenue,\r\n    }));\r\n  }\r\n\r\n  async getOrderChart(period: string = '30d') {\r\n    const startDate = this.getDateRange(period);\r\n\r\n    const orders = await this.prisma.order.findMany({\r\n      where: { createdAt: { gte: startDate } },\r\n      select: {\r\n        status: true,\r\n        createdAt: true,\r\n      },\r\n      orderBy: { createdAt: 'asc' },\r\n    });\r\n\r\n    // Group by date with status breakdown\r\n    const grouped = new Map<\r\n      string,\r\n      { total: number; delivered: number; cancelled: number }\r\n    >();\r\n    orders.forEach((order) => {\r\n      const dateKey = order.createdAt.toISOString().split('T')[0];\r\n      const current = grouped.get(dateKey) || {\r\n        total: 0,\r\n        delivered: 0,\r\n        cancelled: 0,\r\n      };\r\n      current.total++;\r\n      if (order.status === 'DELIVERED') current.delivered++;\r\n      if (order.status === 'CANCELLED') current.cancelled++;\r\n      grouped.set(dateKey, current);\r\n    });\r\n\r\n    return Array.from(grouped.entries()).map(([date, data]) => ({\r\n      date,\r\n      ...data,\r\n    }));\r\n  }\r\n\r\n  async getTopProducts(limit: number = 10) {\r\n    const orderItems = await this.prisma.orderItem.findMany({\r\n      where: {\r\n        order: { status: { not: 'CANCELLED' } },\r\n      },\r\n      select: {\r\n        productId: true,\r\n        quantity: true,\r\n        price: true,\r\n        product: {\r\n          select: {\r\n            name: true,\r\n            imageUrl: true,\r\n            price: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Aggregate by product\r\n    const productMap = new Map<\r\n      string,\r\n      {\r\n        name: string;\r\n        imageUrl: string | null;\r\n        currentPrice: number;\r\n        totalQuantity: number;\r\n        totalRevenue: number;\r\n      }\r\n    >();\r\n\r\n    orderItems.forEach((item) => {\r\n      const current = productMap.get(item.productId) || {\r\n        name: item.product.name,\r\n        imageUrl: item.product.imageUrl,\r\n        currentPrice: item.product.price,\r\n        totalQuantity: 0,\r\n        totalRevenue: 0,\r\n      };\r\n      current.totalQuantity += item.quantity;\r\n      current.totalRevenue += item.price * item.quantity;\r\n      productMap.set(item.productId, current);\r\n    });\r\n\r\n    return Array.from(productMap.entries())\r\n      .map(([productId, data]) => ({ productId, ...data }))\r\n      .sort((a, b) => b.totalRevenue - a.totalRevenue)\r\n      .slice(0, limit);\r\n  }\r\n\r\n  async getTopCustomers(limit: number = 10) {\r\n    const orders = await this.prisma.order.findMany({\r\n      where: { status: { not: 'CANCELLED' } },\r\n      select: {\r\n        userId: true,\r\n        totalAmount: true,\r\n        discountAmount: true,\r\n        user: {\r\n          select: {\r\n            fullName: true,\r\n            email: true,\r\n            avatarUrl: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Aggregate by user\r\n    const userMap = new Map<\r\n      string,\r\n      {\r\n        fullName: string | null;\r\n        email: string;\r\n        avatarUrl: string | null;\r\n        orderCount: number;\r\n        totalSpent: number;\r\n      }\r\n    >();\r\n\r\n    orders.forEach((order) => {\r\n      const current = userMap.get(order.userId) || {\r\n        fullName: order.user.fullName,\r\n        email: order.user.email,\r\n        avatarUrl: order.user.avatarUrl,\r\n        orderCount: 0,\r\n        totalSpent: 0,\r\n      };\r\n      current.orderCount++;\r\n      current.totalSpent += order.totalAmount - order.discountAmount;\r\n      userMap.set(order.userId, current);\r\n    });\r\n\r\n    return Array.from(userMap.entries())\r\n      .map(([userId, data]) => ({ userId, ...data }))\r\n      .sort((a, b) => b.totalSpent - a.totalSpent)\r\n      .slice(0, limit);\r\n  }\r\n\r\n  async getCategoryBreakdown() {\r\n    const orderItems = await this.prisma.orderItem.findMany({\r\n      where: {\r\n        order: { status: { not: 'CANCELLED' } },\r\n      },\r\n      select: {\r\n        quantity: true,\r\n        price: true,\r\n        product: {\r\n          select: {\r\n            category: {\r\n              select: { id: true, name: true },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    const categoryMap = new Map<\r\n      string,\r\n      { name: string; revenue: number; quantity: number }\r\n    >();\r\n\r\n    orderItems.forEach((item) => {\r\n      const catId = item.product.category.id;\r\n      const catName = item.product.category.name;\r\n      const current = categoryMap.get(catId) || {\r\n        name: catName,\r\n        revenue: 0,\r\n        quantity: 0,\r\n      };\r\n      current.revenue += item.price * item.quantity;\r\n      current.quantity += item.quantity;\r\n      categoryMap.set(catId, current);\r\n    });\r\n\r\n    return Array.from(categoryMap.entries())\r\n      .map(([categoryId, data]) => ({ categoryId, ...data }))\r\n      .sort((a, b) => b.revenue - a.revenue);\r\n  }\r\n\r\n  async getConversionStats() {\r\n    const now = new Date();\r\n    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\r\n\r\n    const [totalCarts, totalOrders, deliveredOrders, cancelledOrders] =\r\n      await Promise.all([\r\n        this.prisma.cart.count({\r\n          where: {\r\n            cartItems: { some: {} },\r\n          },\r\n        }),\r\n        this.prisma.order.count({\r\n          where: { createdAt: { gte: thirtyDaysAgo } },\r\n        }),\r\n        this.prisma.order.count({\r\n          where: {\r\n            createdAt: { gte: thirtyDaysAgo },\r\n            status: 'DELIVERED',\r\n          },\r\n        }),\r\n        this.prisma.order.count({\r\n          where: {\r\n            createdAt: { gte: thirtyDaysAgo },\r\n            status: 'CANCELLED',\r\n          },\r\n        }),\r\n      ]);\r\n\r\n    const revenueResult = await this.prisma.order.aggregate({\r\n      where: {\r\n        createdAt: { gte: thirtyDaysAgo },\r\n        status: { not: 'CANCELLED' },\r\n      },\r\n      _sum: { totalAmount: true, discountAmount: true },\r\n      _avg: { totalAmount: true },\r\n    });\r\n\r\n    return {\r\n      activeCarts: totalCarts,\r\n      totalOrders,\r\n      deliveredOrders,\r\n      cancelledOrders,\r\n      conversionRate:\r\n        totalCarts > 0\r\n          ? Math.round((totalOrders / totalCarts) * 100 * 10) / 10\r\n          : 0,\r\n      deliveryRate:\r\n        totalOrders > 0\r\n          ? Math.round((deliveredOrders / totalOrders) * 100 * 10) / 10\r\n          : 0,\r\n      cancellationRate:\r\n        totalOrders > 0\r\n          ? Math.round((cancelledOrders / totalOrders) * 100 * 10) / 10\r\n          : 0,\r\n      totalRevenue:\r\n        (revenueResult._sum.totalAmount || 0) -\r\n        (revenueResult._sum.discountAmount || 0),\r\n      avgOrderValue: revenueResult._avg.totalAmount || 0,\r\n    };\r\n  }\r\n}\r\n"],"names":["ReportsService","exportOrders","startDate","endDate","where","createdAt","gte","lte","orders","prisma","order","findMany","include","user","select","fullName","email","orderItems","product","name","orderBy","workbook","ExcelJS","Workbook","creator","created","Date","sheet","addWorksheet","columns","header","key","width","getRow","font","bold","fill","type","pattern","fgColor","argb","color","statusLabels","PENDING","PROCESSING","SHIPPED","DELIVERED","CANCELLED","forEach","products","map","item","quantity","join","addRow","id","customer","total","totalAmount","discount","discountAmount","status","payment","paymentMethod","address","date","toLocaleDateString","eachRow","row","rowNumber","eachCell","cell","border","top","style","left","bottom","right","alignment","vertical","wrapText","buffer","xlsx","writeBuffer","StreamableFile","Buffer","from","disposition","now","exportProducts","deletedAt","category","price","stock","getCell","getDateRange","period","getTime","getRevenueChart","not","shippingFee","grouped","Map","dateKey","toISOString","split","revenue","set","get","Array","entries","getOrderChart","current","delivered","cancelled","data","getTopProducts","limit","orderItem","productId","imageUrl","productMap","currentPrice","totalQuantity","totalRevenue","sort","a","b","slice","getTopCustomers","userId","avatarUrl","userMap","orderCount","totalSpent","getCategoryBreakdown","categoryMap","catId","catName","categoryId","getConversionStats","thirtyDaysAgo","totalCarts","totalOrders","deliveredOrders","cancelledOrders","Promise","all","cart","count","cartItems","some","revenueResult","aggregate","_sum","_avg","activeCarts","conversionRate","Math","round","deliveryRate","cancellationRate","avgOrderValue"],"mappings":"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"}
{"version":3,"sources":["../../src/flash-sale/flash-sale.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateFlashSaleDto } from './dto/create-flash-sale.dto';\r\nimport { UpdateFlashSaleDto } from './dto/update-flash-sale.dto';\r\nimport { AddFlashSaleItemDto } from './dto/add-item.dto';\r\n\r\n@Injectable()\r\nexport class FlashSaleService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async create(dto: CreateFlashSaleDto) {\r\n    const start = new Date(dto.startTime);\r\n    const end = new Date(dto.endTime);\r\n\r\n    if (end <= start) {\r\n      throw new BadRequestException('endTime pháº£i sau startTime');\r\n    }\r\n\r\n    return this.prisma.flashSale.create({\r\n      data: {\r\n        name: dto.name,\r\n        startTime: start,\r\n        endTime: end,\r\n        items: {\r\n          create: dto.items.map((item) => ({\r\n            productId: item.productId,\r\n            salePrice: item.salePrice,\r\n            saleQty: item.saleQty,\r\n            limitPerUser: item.limitPerUser ?? 1,\r\n          })),\r\n        },\r\n      },\r\n      include: {\r\n        items: {\r\n          include: {\r\n            product: { select: { name: true, price: true, imageUrl: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async findAll() {\r\n    return this.prisma.flashSale.findMany({\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        items: {\r\n          include: {\r\n            product: {\r\n              select: { name: true, price: true, imageUrl: true },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async findOne(id: string) {\r\n    const sale = await this.prisma.flashSale.findUnique({\r\n      where: { id },\r\n      include: {\r\n        items: {\r\n          include: {\r\n            product: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                price: true,\r\n                imageUrl: true,\r\n                stock: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!sale) throw new NotFoundException('Flash Sale not found');\r\n    return sale;\r\n  }\r\n\r\n  async update(id: string, dto: UpdateFlashSaleDto) {\r\n    await this.findOne(id);\r\n\r\n    const data: Record<string, unknown> = {};\r\n    if (dto.name !== undefined) data.name = dto.name;\r\n    if (dto.isActive !== undefined) data.isActive = dto.isActive;\r\n    if (dto.startTime) data.startTime = new Date(dto.startTime);\r\n    if (dto.endTime) data.endTime = new Date(dto.endTime);\r\n\r\n    return this.prisma.flashSale.update({\r\n      where: { id },\r\n      data,\r\n      include: {\r\n        items: {\r\n          include: {\r\n            product: { select: { name: true, price: true, imageUrl: true } },\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async remove(id: string) {\r\n    await this.findOne(id);\r\n    return this.prisma.flashSale.delete({ where: { id } });\r\n  }\r\n\r\n  async addItem(flashSaleId: string, dto: AddFlashSaleItemDto) {\r\n    await this.findOne(flashSaleId);\r\n\r\n    const existing = await this.prisma.flashSaleItem.findUnique({\r\n      where: {\r\n        flashSaleId_productId: {\r\n          flashSaleId,\r\n          productId: dto.productId,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (existing) {\r\n      throw new BadRequestException('Product already in this flash sale');\r\n    }\r\n\r\n    return this.prisma.flashSaleItem.create({\r\n      data: {\r\n        flashSaleId,\r\n        productId: dto.productId,\r\n        salePrice: dto.salePrice,\r\n        saleQty: dto.saleQty,\r\n        limitPerUser: dto.limitPerUser ?? 1,\r\n      },\r\n      include: {\r\n        product: { select: { name: true, price: true, imageUrl: true } },\r\n      },\r\n    });\r\n  }\r\n\r\n  async removeItem(flashSaleId: string, itemId: string) {\r\n    const item = await this.prisma.flashSaleItem.findFirst({\r\n      where: { id: itemId, flashSaleId },\r\n    });\r\n\r\n    if (!item) throw new NotFoundException('Flash sale item not found');\r\n\r\n    return this.prisma.flashSaleItem.delete({ where: { id: itemId } });\r\n  }\r\n\r\n  async getActiveFlashSales() {\r\n    const now = new Date();\r\n\r\n    return this.prisma.flashSale.findMany({\r\n      where: {\r\n        isActive: true,\r\n        startTime: { lte: now },\r\n        endTime: { gte: now },\r\n      },\r\n      include: {\r\n        items: {\r\n          include: {\r\n            product: {\r\n              select: {\r\n                id: true,\r\n                name: true,\r\n                price: true,\r\n                imageUrl: true,\r\n                stock: true,\r\n              },\r\n            },\r\n          },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async checkFlashSalePrice(\r\n    productId: string,\r\n    userId: string,\r\n  ): Promise<{ salePrice: number; flashSaleItemId: string } | null> {\r\n    const now = new Date();\r\n\r\n    const flashSaleItem = await this.prisma.flashSaleItem.findFirst({\r\n      where: {\r\n        productId,\r\n        flashSale: {\r\n          isActive: true,\r\n          startTime: { lte: now },\r\n          endTime: { gte: now },\r\n        },\r\n      },\r\n      include: {\r\n        flashSale: { select: { startTime: true } },\r\n      },\r\n    });\r\n\r\n    if (!flashSaleItem) return null;\r\n\r\n    // Check stock availability\r\n    if (flashSaleItem.soldQty >= flashSaleItem.saleQty) return null;\r\n\r\n    // Check user purchase limit during this flash sale\r\n    const userPurchaseCount = await this.prisma.orderItem.count({\r\n      where: {\r\n        productId,\r\n        order: {\r\n          userId,\r\n          status: { notIn: ['CANCELLED'] },\r\n          createdAt: { gte: flashSaleItem.flashSale.startTime },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (userPurchaseCount >= flashSaleItem.limitPerUser) return null;\r\n\r\n    return {\r\n      salePrice: flashSaleItem.salePrice,\r\n      flashSaleItemId: flashSaleItem.id,\r\n    };\r\n  }\r\n\r\n  async incrementSoldQty(flashSaleItemId: string, qty: number) {\r\n    return this.prisma.flashSaleItem.update({\r\n      where: { id: flashSaleItemId },\r\n      data: { soldQty: { increment: qty } },\r\n    });\r\n  }\r\n}\r\n"],"names":["FlashSaleService","create","dto","start","Date","startTime","end","endTime","BadRequestException","prisma","flashSale","data","name","items","map","item","productId","salePrice","saleQty","limitPerUser","include","product","select","price","imageUrl","findAll","findMany","orderBy","createdAt","findOne","id","sale","findUnique","where","stock","NotFoundException","update","undefined","isActive","remove","delete","addItem","flashSaleId","existing","flashSaleItem","flashSaleId_productId","removeItem","itemId","findFirst","getActiveFlashSales","now","lte","gte","checkFlashSalePrice","userId","soldQty","userPurchaseCount","orderItem","count","order","status","notIn","flashSaleItemId","incrementSoldQty","qty","increment"],"mappings":";;;;+BAWaA;;;eAAAA;;;wBAPN;+BACuB;;;;;;;;;;AAMvB,IAAA,AAAMA,mBAAN,MAAMA;IAGX,MAAMC,OAAOC,GAAuB,EAAE;QACpC,MAAMC,QAAQ,IAAIC,KAAKF,IAAIG,SAAS;QACpC,MAAMC,MAAM,IAAIF,KAAKF,IAAIK,OAAO;QAEhC,IAAID,OAAOH,OAAO;YAChB,MAAM,IAAIK,2BAAmB,CAAC;QAChC;QAEA,OAAO,IAAI,CAACC,MAAM,CAACC,SAAS,CAACT,MAAM,CAAC;YAClCU,MAAM;gBACJC,MAAMV,IAAIU,IAAI;gBACdP,WAAWF;gBACXI,SAASD;gBACTO,OAAO;oBACLZ,QAAQC,IAAIW,KAAK,CAACC,GAAG,CAAC,CAACC,OAAU,CAAA;4BAC/BC,WAAWD,KAAKC,SAAS;4BACzBC,WAAWF,KAAKE,SAAS;4BACzBC,SAASH,KAAKG,OAAO;4BACrBC,cAAcJ,KAAKI,YAAY,IAAI;wBACrC,CAAA;gBACF;YACF;YACAC,SAAS;gBACPP,OAAO;oBACLO,SAAS;wBACPC,SAAS;4BAAEC,QAAQ;gCAAEV,MAAM;gCAAMW,OAAO;gCAAMC,UAAU;4BAAK;wBAAE;oBACjE;gBACF;YACF;QACF;IACF;IAEA,MAAMC,UAAU;QACd,OAAO,IAAI,CAAChB,MAAM,CAACC,SAAS,CAACgB,QAAQ,CAAC;YACpCC,SAAS;gBAAEC,WAAW;YAAO;YAC7BR,SAAS;gBACPP,OAAO;oBACLO,SAAS;wBACPC,SAAS;4BACPC,QAAQ;gCAAEV,MAAM;gCAAMW,OAAO;gCAAMC,UAAU;4BAAK;wBACpD;oBACF;gBACF;YACF;QACF;IACF;IAEA,MAAMK,QAAQC,EAAU,EAAE;QACxB,MAAMC,OAAO,MAAM,IAAI,CAACtB,MAAM,CAACC,SAAS,CAACsB,UAAU,CAAC;YAClDC,OAAO;gBAAEH;YAAG;YACZV,SAAS;gBACPP,OAAO;oBACLO,SAAS;wBACPC,SAAS;4BACPC,QAAQ;gCACNQ,IAAI;gCACJlB,MAAM;gCACNW,OAAO;gCACPC,UAAU;gCACVU,OAAO;4BACT;wBACF;oBACF;gBACF;YACF;QACF;QAEA,IAAI,CAACH,MAAM,MAAM,IAAII,yBAAiB,CAAC;QACvC,OAAOJ;IACT;IAEA,MAAMK,OAAON,EAAU,EAAE5B,GAAuB,EAAE;QAChD,MAAM,IAAI,CAAC2B,OAAO,CAACC;QAEnB,MAAMnB,OAAgC,CAAC;QACvC,IAAIT,IAAIU,IAAI,KAAKyB,WAAW1B,KAAKC,IAAI,GAAGV,IAAIU,IAAI;QAChD,IAAIV,IAAIoC,QAAQ,KAAKD,WAAW1B,KAAK2B,QAAQ,GAAGpC,IAAIoC,QAAQ;QAC5D,IAAIpC,IAAIG,SAAS,EAAEM,KAAKN,SAAS,GAAG,IAAID,KAAKF,IAAIG,SAAS;QAC1D,IAAIH,IAAIK,OAAO,EAAEI,KAAKJ,OAAO,GAAG,IAAIH,KAAKF,IAAIK,OAAO;QAEpD,OAAO,IAAI,CAACE,MAAM,CAACC,SAAS,CAAC0B,MAAM,CAAC;YAClCH,OAAO;gBAAEH;YAAG;YACZnB;YACAS,SAAS;gBACPP,OAAO;oBACLO,SAAS;wBACPC,SAAS;4BAAEC,QAAQ;gCAAEV,MAAM;gCAAMW,OAAO;gCAAMC,UAAU;4BAAK;wBAAE;oBACjE;gBACF;YACF;QACF;IACF;IAEA,MAAMe,OAAOT,EAAU,EAAE;QACvB,MAAM,IAAI,CAACD,OAAO,CAACC;QACnB,OAAO,IAAI,CAACrB,MAAM,CAACC,SAAS,CAAC8B,MAAM,CAAC;YAAEP,OAAO;gBAAEH;YAAG;QAAE;IACtD;IAEA,MAAMW,QAAQC,WAAmB,EAAExC,GAAwB,EAAE;QAC3D,MAAM,IAAI,CAAC2B,OAAO,CAACa;QAEnB,MAAMC,WAAW,MAAM,IAAI,CAAClC,MAAM,CAACmC,aAAa,CAACZ,UAAU,CAAC;YAC1DC,OAAO;gBACLY,uBAAuB;oBACrBH;oBACA1B,WAAWd,IAAIc,SAAS;gBAC1B;YACF;QACF;QAEA,IAAI2B,UAAU;YACZ,MAAM,IAAInC,2BAAmB,CAAC;QAChC;QAEA,OAAO,IAAI,CAACC,MAAM,CAACmC,aAAa,CAAC3C,MAAM,CAAC;YACtCU,MAAM;gBACJ+B;gBACA1B,WAAWd,IAAIc,SAAS;gBACxBC,WAAWf,IAAIe,SAAS;gBACxBC,SAAShB,IAAIgB,OAAO;gBACpBC,cAAcjB,IAAIiB,YAAY,IAAI;YACpC;YACAC,SAAS;gBACPC,SAAS;oBAAEC,QAAQ;wBAAEV,MAAM;wBAAMW,OAAO;wBAAMC,UAAU;oBAAK;gBAAE;YACjE;QACF;IACF;IAEA,MAAMsB,WAAWJ,WAAmB,EAAEK,MAAc,EAAE;QACpD,MAAMhC,OAAO,MAAM,IAAI,CAACN,MAAM,CAACmC,aAAa,CAACI,SAAS,CAAC;YACrDf,OAAO;gBAAEH,IAAIiB;gBAAQL;YAAY;QACnC;QAEA,IAAI,CAAC3B,MAAM,MAAM,IAAIoB,yBAAiB,CAAC;QAEvC,OAAO,IAAI,CAAC1B,MAAM,CAACmC,aAAa,CAACJ,MAAM,CAAC;YAAEP,OAAO;gBAAEH,IAAIiB;YAAO;QAAE;IAClE;IAEA,MAAME,sBAAsB;QAC1B,MAAMC,MAAM,IAAI9C;QAEhB,OAAO,IAAI,CAACK,MAAM,CAACC,SAAS,CAACgB,QAAQ,CAAC;YACpCO,OAAO;gBACLK,UAAU;gBACVjC,WAAW;oBAAE8C,KAAKD;gBAAI;gBACtB3C,SAAS;oBAAE6C,KAAKF;gBAAI;YACtB;YACA9B,SAAS;gBACPP,OAAO;oBACLO,SAAS;wBACPC,SAAS;4BACPC,QAAQ;gCACNQ,IAAI;gCACJlB,MAAM;gCACNW,OAAO;gCACPC,UAAU;gCACVU,OAAO;4BACT;wBACF;oBACF;gBACF;YACF;QACF;IACF;IAEA,MAAMmB,oBACJrC,SAAiB,EACjBsC,MAAc,EACkD;QAChE,MAAMJ,MAAM,IAAI9C;QAEhB,MAAMwC,gBAAgB,MAAM,IAAI,CAACnC,MAAM,CAACmC,aAAa,CAACI,SAAS,CAAC;YAC9Df,OAAO;gBACLjB;gBACAN,WAAW;oBACT4B,UAAU;oBACVjC,WAAW;wBAAE8C,KAAKD;oBAAI;oBACtB3C,SAAS;wBAAE6C,KAAKF;oBAAI;gBACtB;YACF;YACA9B,SAAS;gBACPV,WAAW;oBAAEY,QAAQ;wBAAEjB,WAAW;oBAAK;gBAAE;YAC3C;QACF;QAEA,IAAI,CAACuC,eAAe,OAAO;QAE3B,2BAA2B;QAC3B,IAAIA,cAAcW,OAAO,IAAIX,cAAc1B,OAAO,EAAE,OAAO;QAE3D,mDAAmD;QACnD,MAAMsC,oBAAoB,MAAM,IAAI,CAAC/C,MAAM,CAACgD,SAAS,CAACC,KAAK,CAAC;YAC1DzB,OAAO;gBACLjB;gBACA2C,OAAO;oBACLL;oBACAM,QAAQ;wBAAEC,OAAO;4BAAC;yBAAY;oBAAC;oBAC/BjC,WAAW;wBAAEwB,KAAKR,cAAclC,SAAS,CAACL,SAAS;oBAAC;gBACtD;YACF;QACF;QAEA,IAAImD,qBAAqBZ,cAAczB,YAAY,EAAE,OAAO;QAE5D,OAAO;YACLF,WAAW2B,cAAc3B,SAAS;YAClC6C,iBAAiBlB,cAAcd,EAAE;QACnC;IACF;IAEA,MAAMiC,iBAAiBD,eAAuB,EAAEE,GAAW,EAAE;QAC3D,OAAO,IAAI,CAACvD,MAAM,CAACmC,aAAa,CAACR,MAAM,CAAC;YACtCH,OAAO;gBAAEH,IAAIgC;YAAgB;YAC7BnD,MAAM;gBAAE4C,SAAS;oBAAEU,WAAWD;gBAAI;YAAE;QACtC;IACF;IAzNA,YAAY,AAAQvD,MAAqB,CAAE;aAAvBA,SAAAA;IAAwB;AA0N9C"}
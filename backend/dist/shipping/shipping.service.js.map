{"version":3,"sources":["../../src/shipping/shipping.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateShippingZoneDto, UpdateShippingZoneDto } from './dto';\r\n\r\n@Injectable()\r\nexport class ShippingService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // Get all active zones (public)\r\n  async getActiveZones() {\r\n    return this.prisma.shippingZone.findMany({\r\n      where: { isActive: true },\r\n      include: { provinces: true },\r\n      orderBy: { name: 'asc' },\r\n    });\r\n  }\r\n\r\n  // Get all zones (admin)\r\n  async getAllZones() {\r\n    return this.prisma.shippingZone.findMany({\r\n      include: { provinces: true },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // Get zone by ID\r\n  async getZoneById(id: string) {\r\n    const zone = await this.prisma.shippingZone.findUnique({\r\n      where: { id },\r\n      include: { provinces: true },\r\n    });\r\n    if (!zone) {\r\n      throw new NotFoundException('Shipping zone not found');\r\n    }\r\n    return zone;\r\n  }\r\n\r\n  // Create zone\r\n  async createZone(dto: CreateShippingZoneDto) {\r\n    return this.prisma.shippingZone.create({\r\n      data: {\r\n        name: dto.name,\r\n        fee: dto.fee,\r\n        minOrderFree: dto.minOrderFree,\r\n        estimatedDays: dto.estimatedDays,\r\n        isActive: dto.isActive ?? true,\r\n      },\r\n      include: { provinces: true },\r\n    });\r\n  }\r\n\r\n  // Update zone\r\n  async updateZone(id: string, dto: UpdateShippingZoneDto) {\r\n    await this.getZoneById(id); // Check exists\r\n    return this.prisma.shippingZone.update({\r\n      where: { id },\r\n      data: dto,\r\n      include: { provinces: true },\r\n    });\r\n  }\r\n\r\n  // Delete zone\r\n  async deleteZone(id: string) {\r\n    await this.getZoneById(id); // Check exists\r\n    await this.prisma.shippingZone.delete({ where: { id } });\r\n    return { message: 'Shipping zone deleted successfully' };\r\n  }\r\n\r\n  // Assign provinces to zone\r\n  async assignProvinces(zoneId: string, provinces: string[]) {\r\n    await this.getZoneById(zoneId); // Check exists\r\n\r\n    // Remove existing provinces for this zone\r\n    await this.prisma.shippingProvince.deleteMany({\r\n      where: { zoneId },\r\n    });\r\n\r\n    // Create new province mappings\r\n    await this.prisma.shippingProvince.createMany({\r\n      data: provinces.map((province) => ({\r\n        zoneId,\r\n        province,\r\n      })),\r\n      skipDuplicates: true,\r\n    });\r\n\r\n    return this.getZoneById(zoneId);\r\n  }\r\n\r\n  // Calculate shipping fee by province\r\n  async calculateFee(province: string, orderTotal?: number) {\r\n    // Find zone for this province\r\n    const shippingProvince = await this.prisma.shippingProvince.findUnique({\r\n      where: { province },\r\n      include: { zone: true },\r\n    });\r\n\r\n    if (!shippingProvince || !shippingProvince.zone.isActive) {\r\n      // Default fee if province not in any zone\r\n      return {\r\n        fee: 0,\r\n        zone: null,\r\n        isFreeShipping: false,\r\n        message: 'Province not in shipping zones',\r\n      };\r\n    }\r\n\r\n    const zone = shippingProvince.zone;\r\n\r\n    // Check free shipping threshold\r\n    const isFreeShipping = zone.minOrderFree\r\n      ? (orderTotal ?? 0) >= zone.minOrderFree\r\n      : false;\r\n\r\n    return {\r\n      fee: isFreeShipping ? 0 : zone.fee,\r\n      zone: {\r\n        id: zone.id,\r\n        name: zone.name,\r\n        estimatedDays: zone.estimatedDays,\r\n        minOrderFree: zone.minOrderFree,\r\n      },\r\n      isFreeShipping,\r\n      message: isFreeShipping\r\n        ? `Miễn phí vận chuyển cho đơn từ ${zone.minOrderFree?.toLocaleString('vi-VN')}đ`\r\n        : null,\r\n    };\r\n  }\r\n\r\n  // Get all provinces with their zones\r\n  async getAllProvinces() {\r\n    return this.prisma.shippingProvince.findMany({\r\n      include: { zone: { select: { id: true, name: true, fee: true } } },\r\n      orderBy: { province: 'asc' },\r\n    });\r\n  }\r\n}\r\n"],"names":["ShippingService","getActiveZones","prisma","shippingZone","findMany","where","isActive","include","provinces","orderBy","name","getAllZones","createdAt","getZoneById","id","zone","findUnique","NotFoundException","createZone","dto","create","data","fee","minOrderFree","estimatedDays","updateZone","update","deleteZone","delete","message","assignProvinces","zoneId","shippingProvince","deleteMany","createMany","map","province","skipDuplicates","calculateFee","orderTotal","isFreeShipping","toLocaleString","getAllProvinces","select"],"mappings":"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"}
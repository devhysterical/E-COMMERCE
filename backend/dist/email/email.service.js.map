{"version":3,"sources":["../../src/email/email.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport * as nodemailer from 'nodemailer';\r\n\r\n@Injectable()\r\nexport class EmailService {\r\n  private transporter: nodemailer.Transporter;\r\n\r\n  constructor() {\r\n    // Cấu hình SMTP transporter\r\n    this.transporter = nodemailer.createTransport({\r\n      host: process.env.SMTP_HOST || 'smtp.gmail.com',\r\n      port: parseInt(process.env.SMTP_PORT || '587'),\r\n      secure: false, // true for 465, false for other ports\r\n      auth: {\r\n        user: process.env.SMTP_USER,\r\n        pass: process.env.SMTP_PASS,\r\n      },\r\n    });\r\n  }\r\n\r\n  async sendOtpEmail(email: string, otp: string): Promise<void> {\r\n    const mailOptions = {\r\n      from: `\"E-Commerce\" <${process.env.SMTP_USER}>`,\r\n      to: email,\r\n      subject: 'Mã xác thực đăng ký tài khoản',\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\r\n          <h2 style=\"color: #4F46E5; text-align: center;\">Xác thực đăng ký tài khoản</h2>\r\n          <p>Xin chào,</p>\r\n          <p>Mã OTP của bạn là:</p>\r\n          <div style=\"background: linear-gradient(135deg, #4F46E5, #7C3AED); color: white; font-size: 32px; font-weight: bold; text-align: center; padding: 20px; border-radius: 10px; letter-spacing: 8px; margin: 20px 0;\">\r\n            ${otp}\r\n          </div>\r\n          <p style=\"color: #666;\">Mã này có hiệu lực trong <strong>5 phút</strong>.</p>\r\n          <p style=\"color: #666;\">Nếu bạn không yêu cầu mã này, vui lòng bỏ qua email này.</p>\r\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 20px 0;\">\r\n          <p style=\"color: #999; font-size: 12px; text-align: center;\">\r\n            © 2026 E-Commerce. All rights reserved.\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    try {\r\n      await this.transporter.sendMail(mailOptions);\r\n      console.log(`[EMAIL] OTP sent successfully to ${email}`);\r\n    } catch (error) {\r\n      console.error(`[EMAIL] Failed to send OTP to ${email}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async sendPasswordResetEmail(\r\n    email: string,\r\n    resetLink: string,\r\n  ): Promise<void> {\r\n    const mailOptions = {\r\n      from: `\"E-Commerce\" <${process.env.SMTP_USER}>`,\r\n      to: email,\r\n      subject: 'Đặt lại mật khẩu',\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\r\n          <h2 style=\"color: #4F46E5; text-align: center;\">Đặt lại mật khẩu</h2>\r\n          <p>Xin chào,</p>\r\n          <p>Bạn đã yêu cầu đặt lại mật khẩu. Nhấn nút bên dưới để đặt mật khẩu mới:</p>\r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <a href=\"${resetLink}\" style=\"background: linear-gradient(135deg, #4F46E5, #7C3AED); color: white; padding: 15px 30px; text-decoration: none; border-radius: 10px; font-weight: bold;\">\r\n              Đặt lại mật khẩu\r\n            </a>\r\n          </div>\r\n          <p style=\"color: #666;\">Link này có hiệu lực trong <strong>1 giờ</strong>.</p>\r\n          <p style=\"color: #666;\">Nếu bạn không yêu cầu đặt lại mật khẩu, vui lòng bỏ qua email này.</p>\r\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 20px 0;\">\r\n          <p style=\"color: #999; font-size: 12px; text-align: center;\">\r\n            © 2026 E-Commerce. All rights reserved.\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    try {\r\n      await this.transporter.sendMail(mailOptions);\r\n      console.log(`[EMAIL] Password reset email sent to ${email}`);\r\n    } catch (error) {\r\n      console.error(\r\n        `[EMAIL] Failed to send password reset to ${email}:`,\r\n        error,\r\n      );\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async sendOrderConfirmationEmail(\r\n    email: string,\r\n    orderData: {\r\n      orderId: string;\r\n      totalAmount: number;\r\n      discountAmount: number;\r\n      items: { name: string; quantity: number; price: number }[];\r\n      address: string;\r\n      paymentMethod: string;\r\n    },\r\n  ): Promise<void> {\r\n    const itemsHtml = orderData.items\r\n      .map(\r\n        (item) => `\r\n        <tr>\r\n          <td style=\"padding: 10px; border-bottom: 1px solid #eee;\">${item.name}</td>\r\n          <td style=\"padding: 10px; border-bottom: 1px solid #eee; text-align: center;\">${item.quantity}</td>\r\n          <td style=\"padding: 10px; border-bottom: 1px solid #eee; text-align: right;\">${item.price.toLocaleString('vi-VN')}đ</td>\r\n        </tr>\r\n      `,\r\n      )\r\n      .join('');\r\n\r\n    const finalAmount = orderData.totalAmount - orderData.discountAmount;\r\n\r\n    const mailOptions = {\r\n      from: `\"E-Commerce\" <${process.env.SMTP_USER}>`,\r\n      to: email,\r\n      subject: `Xác nhận đơn hàng #${orderData.orderId.slice(0, 8).toUpperCase()}`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\r\n          <h2 style=\"color: #4F46E5; text-align: center;\">Đặt hàng thành công!</h2>\r\n          <p>Cảm ơn bạn đã đặt hàng tại E-Commerce.</p>\r\n          \r\n          <div style=\"background: #f8fafc; padding: 20px; border-radius: 10px; margin: 20px 0;\">\r\n            <p style=\"margin: 0;\"><strong>Mã đơn hàng:</strong> #${orderData.orderId.slice(0, 8).toUpperCase()}</p>\r\n            <p style=\"margin: 10px 0 0;\"><strong>Địa chỉ giao hàng:</strong> ${orderData.address}</p>\r\n            <p style=\"margin: 10px 0 0;\"><strong>Phương thức thanh toán:</strong> ${orderData.paymentMethod === 'COD' ? 'Thanh toán khi nhận hàng' : 'MoMo'}</p>\r\n          </div>\r\n\r\n          <table style=\"width: 100%; border-collapse: collapse; margin: 20px 0;\">\r\n            <thead>\r\n              <tr style=\"background: #4F46E5; color: white;\">\r\n                <th style=\"padding: 12px; text-align: left;\">Sản phẩm</th>\r\n                <th style=\"padding: 12px; text-align: center;\">SL</th>\r\n                <th style=\"padding: 12px; text-align: right;\">Giá</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              ${itemsHtml}\r\n            </tbody>\r\n          </table>\r\n\r\n          <div style=\"text-align: right; padding: 10px 0;\">\r\n            <p style=\"margin: 5px 0;\">Tạm tính: <strong>${(orderData.totalAmount + orderData.discountAmount).toLocaleString('vi-VN')}đ</strong></p>\r\n            ${orderData.discountAmount > 0 ? `<p style=\"margin: 5px 0; color: #16a34a;\">Giảm giá: <strong>-${orderData.discountAmount.toLocaleString('vi-VN')}đ</strong></p>` : ''}\r\n            <p style=\"margin: 5px 0; font-size: 18px; color: #4F46E5;\">Tổng cộng: <strong>${finalAmount.toLocaleString('vi-VN')}đ</strong></p>\r\n          </div>\r\n\r\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 20px 0;\">\r\n          <p style=\"color: #999; font-size: 12px; text-align: center;\">\r\n            © 2026 E-Commerce. All rights reserved.\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    try {\r\n      await this.transporter.sendMail(mailOptions);\r\n      console.log(`[EMAIL] Order confirmation sent to ${email}`);\r\n    } catch (error) {\r\n      console.error(\r\n        `[EMAIL] Failed to send order confirmation to ${email}:`,\r\n        error,\r\n      );\r\n      // Don't throw - order was already created, just log the error\r\n    }\r\n  }\r\n\r\n  async sendOrderStatusUpdateEmail(\r\n    email: string,\r\n    orderData: {\r\n      orderId: string;\r\n      status: string;\r\n      statusLabel: string;\r\n    },\r\n  ): Promise<void> {\r\n    const statusColors: Record<string, string> = {\r\n      PENDING: '#eab308',\r\n      PROCESSING: '#3b82f6',\r\n      SHIPPED: '#8b5cf6',\r\n      DELIVERED: '#22c55e',\r\n      CANCELLED: '#ef4444',\r\n    };\r\n\r\n    const color = statusColors[orderData.status] || '#4F46E5';\r\n\r\n    const mailOptions = {\r\n      from: `\"E-Commerce\" <${process.env.SMTP_USER}>`,\r\n      to: email,\r\n      subject: `Cập nhật đơn hàng #${orderData.orderId.slice(0, 8).toUpperCase()}`,\r\n      html: `\r\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;\">\r\n          <h2 style=\"color: #4F46E5; text-align: center;\">Cập nhật trạng thái đơn hàng</h2>\r\n          <p>Đơn hàng <strong>#${orderData.orderId.slice(0, 8).toUpperCase()}</strong> của bạn đã được cập nhật.</p>\r\n          \r\n          <div style=\"text-align: center; margin: 30px 0;\">\r\n            <span style=\"background: ${color}; color: white; padding: 15px 30px; border-radius: 10px; font-weight: bold; font-size: 18px;\">\r\n              ${orderData.statusLabel}\r\n            </span>\r\n          </div>\r\n\r\n          <p style=\"color: #666; text-align: center;\">\r\n            Bạn có thể theo dõi đơn hàng trong phần \"Lịch sử đơn hàng\" trên website của chúng tôi.\r\n          </p>\r\n\r\n          <hr style=\"border: none; border-top: 1px solid #eee; margin: 20px 0;\">\r\n          <p style=\"color: #999; font-size: 12px; text-align: center;\">\r\n            © 2026 E-Commerce. All rights reserved.\r\n          </p>\r\n        </div>\r\n      `,\r\n    };\r\n\r\n    try {\r\n      await this.transporter.sendMail(mailOptions);\r\n      console.log(`[EMAIL] Order status update sent to ${email}`);\r\n    } catch (error) {\r\n      console.error(`[EMAIL] Failed to send status update to ${email}:`, error);\r\n    }\r\n  }\r\n}\r\n"],"names":["EmailService","sendOtpEmail","email","otp","mailOptions","from","process","env","SMTP_USER","to","subject","html","transporter","sendMail","console","log","error","sendPasswordResetEmail","resetLink","sendOrderConfirmationEmail","orderData","itemsHtml","items","map","item","name","quantity","price","toLocaleString","join","finalAmount","totalAmount","discountAmount","orderId","slice","toUpperCase","address","paymentMethod","sendOrderStatusUpdateEmail","statusColors","PENDING","PROCESSING","SHIPPED","DELIVERED","CANCELLED","color","status","statusLabel","nodemailer","createTransport","host","SMTP_HOST","port","parseInt","SMTP_PORT","secure","auth","user","pass","SMTP_PASS"],"mappings":"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"}
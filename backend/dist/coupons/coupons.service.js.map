{"version":3,"sources":["../../src/coupons/coupons.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport {\r\n  CreateCouponDto,\r\n  UpdateCouponDto,\r\n  ValidateCouponDto,\r\n} from './dto/coupon.dto';\r\n\r\n@Injectable()\r\nexport class CouponsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // Admin: Tạo coupon mới\r\n  async create(dto: CreateCouponDto) {\r\n    return this.prisma.coupon.create({\r\n      data: {\r\n        code: dto.code.toUpperCase(),\r\n        description: dto.description,\r\n        discountType: dto.discountType,\r\n        discountValue: dto.discountValue,\r\n        minOrderAmount: dto.minOrderAmount || 0,\r\n        maxDiscount: dto.maxDiscount,\r\n        maxUses: dto.maxUses,\r\n        startDate: dto.startDate ? new Date(dto.startDate) : new Date(),\r\n        expiresAt: dto.expiresAt ? new Date(dto.expiresAt) : null,\r\n        isActive: dto.isActive ?? true,\r\n      },\r\n    });\r\n  }\r\n\r\n  // Admin: Lấy tất cả coupons\r\n  async findAll() {\r\n    return this.prisma.coupon.findMany({\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        _count: {\r\n          select: { usages: true, orders: true },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Admin: Lấy chi tiết coupon\r\n  async findOne(id: string) {\r\n    const coupon = await this.prisma.coupon.findUnique({\r\n      where: { id },\r\n      include: {\r\n        _count: {\r\n          select: { usages: true, orders: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!coupon) {\r\n      throw new NotFoundException('Mã giảm giá không tồn tại');\r\n    }\r\n\r\n    return coupon;\r\n  }\r\n\r\n  // Admin: Cập nhật coupon\r\n  async update(id: string, dto: UpdateCouponDto) {\r\n    await this.findOne(id);\r\n\r\n    return this.prisma.coupon.update({\r\n      where: { id },\r\n      data: {\r\n        ...(dto.code && { code: dto.code.toUpperCase() }),\r\n        ...(dto.description !== undefined && { description: dto.description }),\r\n        ...(dto.discountType && { discountType: dto.discountType }),\r\n        ...(dto.discountValue !== undefined && {\r\n          discountValue: dto.discountValue,\r\n        }),\r\n        ...(dto.minOrderAmount !== undefined && {\r\n          minOrderAmount: dto.minOrderAmount,\r\n        }),\r\n        ...(dto.maxDiscount !== undefined && { maxDiscount: dto.maxDiscount }),\r\n        ...(dto.maxUses !== undefined && { maxUses: dto.maxUses }),\r\n        ...(dto.startDate && { startDate: new Date(dto.startDate) }),\r\n        ...(dto.expiresAt && { expiresAt: new Date(dto.expiresAt) }),\r\n        ...(dto.isActive !== undefined && { isActive: dto.isActive }),\r\n      },\r\n    });\r\n  }\r\n\r\n  // Admin: Xóa coupon\r\n  async remove(id: string) {\r\n    await this.findOne(id);\r\n    await this.prisma.coupon.delete({ where: { id } });\r\n    return { message: 'Đã xóa mã giảm giá' };\r\n  }\r\n\r\n  // User: Lấy danh sách mã giảm giá khả dụng\r\n  async getAvailableCoupons() {\r\n    const now = new Date();\r\n    return this.prisma.coupon.findMany({\r\n      where: {\r\n        isActive: true,\r\n        startDate: { lte: now },\r\n        AND: [\r\n          {\r\n            OR: [{ expiresAt: null }, { expiresAt: { gt: now } }],\r\n          },\r\n        ],\r\n      },\r\n      select: {\r\n        id: true,\r\n        code: true,\r\n        description: true,\r\n        discountType: true,\r\n        discountValue: true,\r\n        minOrderAmount: true,\r\n        maxDiscount: true,\r\n        expiresAt: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  // User: Validate và tính discount\r\n  async validateCoupon(dto: ValidateCouponDto, userId: string) {\r\n    const coupon = await this.prisma.coupon.findUnique({\r\n      where: { code: dto.code.toUpperCase() },\r\n    });\r\n\r\n    if (!coupon) {\r\n      throw new BadRequestException('Mã giảm giá không tồn tại');\r\n    }\r\n\r\n    // Kiểm tra coupon còn active không\r\n    if (!coupon.isActive) {\r\n      throw new BadRequestException('Mã giảm giá đã bị vô hiệu hóa');\r\n    }\r\n\r\n    // Kiểm tra ngày bắt đầu\r\n    if (coupon.startDate > new Date()) {\r\n      throw new BadRequestException('Mã giảm giá chưa có hiệu lực');\r\n    }\r\n\r\n    // Kiểm tra ngày hết hạn\r\n    if (coupon.expiresAt && coupon.expiresAt < new Date()) {\r\n      throw new BadRequestException('Mã giảm giá đã hết hạn');\r\n    }\r\n\r\n    // Kiểm tra số lần sử dụng tối đa\r\n    if (coupon.maxUses && coupon.usedCount >= coupon.maxUses) {\r\n      throw new BadRequestException('Mã giảm giá đã hết lượt sử dụng');\r\n    }\r\n\r\n    // Kiểm tra đơn hàng tối thiểu\r\n    if (dto.orderAmount < coupon.minOrderAmount) {\r\n      throw new BadRequestException(\r\n        `Đơn hàng tối thiểu ${coupon.minOrderAmount.toLocaleString('vi-VN')}đ`,\r\n      );\r\n    }\r\n\r\n    // Kiểm tra user đã dùng coupon này chưa\r\n    const existingUsage = await this.prisma.couponUsage.findUnique({\r\n      where: {\r\n        couponId_userId: { couponId: coupon.id, userId },\r\n      },\r\n    });\r\n\r\n    if (existingUsage) {\r\n      throw new BadRequestException('Bạn đã sử dụng mã giảm giá này rồi');\r\n    }\r\n\r\n    // Tính số tiền giảm giá\r\n    let discountAmount = 0;\r\n\r\n    if (coupon.discountType === 'PERCENTAGE') {\r\n      discountAmount = Math.floor(\r\n        (dto.orderAmount * coupon.discountValue) / 100,\r\n      );\r\n      // Áp dụng maxDiscount nếu có\r\n      if (coupon.maxDiscount && discountAmount > coupon.maxDiscount) {\r\n        discountAmount = coupon.maxDiscount;\r\n      }\r\n    } else {\r\n      // FIXED\r\n      discountAmount = coupon.discountValue;\r\n      // Không giảm quá giá trị đơn hàng\r\n      if (discountAmount > dto.orderAmount) {\r\n        discountAmount = dto.orderAmount;\r\n      }\r\n    }\r\n\r\n    return {\r\n      valid: true,\r\n      couponId: coupon.id,\r\n      code: coupon.code,\r\n      discountType: coupon.discountType,\r\n      discountValue: coupon.discountValue,\r\n      discountAmount,\r\n      message: `Giảm ${discountAmount.toLocaleString('vi-VN')}đ`,\r\n    };\r\n  }\r\n\r\n  // Internal: Sử dụng coupon khi checkout\r\n  async useCoupon(couponId: string, userId: string, orderId: string) {\r\n    // Tăng usedCount\r\n    await this.prisma.coupon.update({\r\n      where: { id: couponId },\r\n      data: { usedCount: { increment: 1 } },\r\n    });\r\n\r\n    // Tạo usage record\r\n    await this.prisma.couponUsage.create({\r\n      data: {\r\n        couponId,\r\n        userId,\r\n        orderId,\r\n      },\r\n    });\r\n  }\r\n}\r\n"],"names":["CouponsService","create","dto","prisma","coupon","data","code","toUpperCase","description","discountType","discountValue","minOrderAmount","maxDiscount","maxUses","startDate","Date","expiresAt","isActive","findAll","findMany","orderBy","createdAt","include","_count","select","usages","orders","findOne","id","findUnique","where","NotFoundException","update","undefined","remove","delete","message","getAvailableCoupons","now","lte","AND","OR","gt","validateCoupon","userId","BadRequestException","usedCount","orderAmount","toLocaleString","existingUsage","couponUsage","couponId_userId","couponId","discountAmount","Math","floor","valid","useCoupon","orderId","increment"],"mappings":"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"}
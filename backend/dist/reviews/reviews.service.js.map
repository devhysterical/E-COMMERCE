{"version":3,"sources":["../../src/reviews/reviews.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  NotFoundException,\r\n  ForbiddenException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateReviewDto, UpdateReviewDto } from './dto/review.dto';\r\n\r\n@Injectable()\r\nexport class ReviewsService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async create(userId: string, dto: CreateReviewDto) {\r\n    // Kiểm tra sản phẩm tồn tại\r\n    const product = await this.prisma.product.findUnique({\r\n      where: { id: dto.productId, deletedAt: null },\r\n    });\r\n\r\n    if (!product) {\r\n      throw new NotFoundException('Sản phẩm không tồn tại');\r\n    }\r\n\r\n    return this.prisma.review.create({\r\n      data: {\r\n        rating: dto.rating,\r\n        comment: dto.comment,\r\n        userId,\r\n        productId: dto.productId,\r\n      },\r\n      include: {\r\n        user: {\r\n          select: { id: true, fullName: true, email: true },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async findByProduct(productId: string) {\r\n    return this.prisma.review.findMany({\r\n      where: { productId },\r\n      include: {\r\n        user: {\r\n          select: { id: true, fullName: true, email: true },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async findOne(id: string) {\r\n    const review = await this.prisma.review.findUnique({\r\n      where: { id },\r\n      include: {\r\n        user: {\r\n          select: { id: true, fullName: true, email: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!review) {\r\n      throw new NotFoundException('Đánh giá không tồn tại');\r\n    }\r\n\r\n    return review;\r\n  }\r\n\r\n  async update(\r\n    id: string,\r\n    userId: string,\r\n    userRole: string,\r\n    dto: UpdateReviewDto,\r\n  ) {\r\n    const review = await this.findOne(id);\r\n\r\n    // Chỉ owner hoặc admin mới được sửa\r\n    if (review.userId !== userId && userRole !== 'ADMIN') {\r\n      throw new ForbiddenException('Bạn không có quyền sửa đánh giá này');\r\n    }\r\n\r\n    return this.prisma.review.update({\r\n      where: { id },\r\n      data: dto,\r\n      include: {\r\n        user: {\r\n          select: { id: true, fullName: true, email: true },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  async remove(id: string, userId: string, userRole: string) {\r\n    const review = await this.findOne(id);\r\n\r\n    // Chỉ owner hoặc admin mới được xóa\r\n    if (review.userId !== userId && userRole !== 'ADMIN') {\r\n      throw new ForbiddenException('Bạn không có quyền xóa đánh giá này');\r\n    }\r\n\r\n    return this.prisma.review.delete({\r\n      where: { id },\r\n    });\r\n  }\r\n\r\n  async getProductStats(productId: string) {\r\n    const stats = await this.prisma.review.aggregate({\r\n      where: { productId },\r\n      _avg: { rating: true },\r\n      _count: { rating: true },\r\n    });\r\n\r\n    return {\r\n      averageRating: stats._avg.rating ?? 0,\r\n      totalReviews: stats._count.rating,\r\n    };\r\n  }\r\n}\r\n"],"names":["ReviewsService","create","userId","dto","product","prisma","findUnique","where","id","productId","deletedAt","NotFoundException","review","data","rating","comment","include","user","select","fullName","email","findByProduct","findMany","orderBy","createdAt","findOne","update","userRole","ForbiddenException","remove","delete","getProductStats","stats","aggregate","_avg","_count","averageRating","totalReviews"],"mappings":";;;;+BASaA;;;eAAAA;;;wBALN;+BACuB;;;;;;;;;;AAIvB,IAAA,AAAMA,iBAAN,MAAMA;IAGX,MAAMC,OAAOC,MAAc,EAAEC,GAAoB,EAAE;QACjD,4BAA4B;QAC5B,MAAMC,UAAU,MAAM,IAAI,CAACC,MAAM,CAACD,OAAO,CAACE,UAAU,CAAC;YACnDC,OAAO;gBAAEC,IAAIL,IAAIM,SAAS;gBAAEC,WAAW;YAAK;QAC9C;QAEA,IAAI,CAACN,SAAS;YACZ,MAAM,IAAIO,yBAAiB,CAAC;QAC9B;QAEA,OAAO,IAAI,CAACN,MAAM,CAACO,MAAM,CAACX,MAAM,CAAC;YAC/BY,MAAM;gBACJC,QAAQX,IAAIW,MAAM;gBAClBC,SAASZ,IAAIY,OAAO;gBACpBb;gBACAO,WAAWN,IAAIM,SAAS;YAC1B;YACAO,SAAS;gBACPC,MAAM;oBACJC,QAAQ;wBAAEV,IAAI;wBAAMW,UAAU;wBAAMC,OAAO;oBAAK;gBAClD;YACF;QACF;IACF;IAEA,MAAMC,cAAcZ,SAAiB,EAAE;QACrC,OAAO,IAAI,CAACJ,MAAM,CAACO,MAAM,CAACU,QAAQ,CAAC;YACjCf,OAAO;gBAAEE;YAAU;YACnBO,SAAS;gBACPC,MAAM;oBACJC,QAAQ;wBAAEV,IAAI;wBAAMW,UAAU;wBAAMC,OAAO;oBAAK;gBAClD;YACF;YACAG,SAAS;gBAAEC,WAAW;YAAO;QAC/B;IACF;IAEA,MAAMC,QAAQjB,EAAU,EAAE;QACxB,MAAMI,SAAS,MAAM,IAAI,CAACP,MAAM,CAACO,MAAM,CAACN,UAAU,CAAC;YACjDC,OAAO;gBAAEC;YAAG;YACZQ,SAAS;gBACPC,MAAM;oBACJC,QAAQ;wBAAEV,IAAI;wBAAMW,UAAU;wBAAMC,OAAO;oBAAK;gBAClD;YACF;QACF;QAEA,IAAI,CAACR,QAAQ;YACX,MAAM,IAAID,yBAAiB,CAAC;QAC9B;QAEA,OAAOC;IACT;IAEA,MAAMc,OACJlB,EAAU,EACVN,MAAc,EACdyB,QAAgB,EAChBxB,GAAoB,EACpB;QACA,MAAMS,SAAS,MAAM,IAAI,CAACa,OAAO,CAACjB;QAElC,oCAAoC;QACpC,IAAII,OAAOV,MAAM,KAAKA,UAAUyB,aAAa,SAAS;YACpD,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QAEA,OAAO,IAAI,CAACvB,MAAM,CAACO,MAAM,CAACc,MAAM,CAAC;YAC/BnB,OAAO;gBAAEC;YAAG;YACZK,MAAMV;YACNa,SAAS;gBACPC,MAAM;oBACJC,QAAQ;wBAAEV,IAAI;wBAAMW,UAAU;wBAAMC,OAAO;oBAAK;gBAClD;YACF;QACF;IACF;IAEA,MAAMS,OAAOrB,EAAU,EAAEN,MAAc,EAAEyB,QAAgB,EAAE;QACzD,MAAMf,SAAS,MAAM,IAAI,CAACa,OAAO,CAACjB;QAElC,oCAAoC;QACpC,IAAII,OAAOV,MAAM,KAAKA,UAAUyB,aAAa,SAAS;YACpD,MAAM,IAAIC,0BAAkB,CAAC;QAC/B;QAEA,OAAO,IAAI,CAACvB,MAAM,CAACO,MAAM,CAACkB,MAAM,CAAC;YAC/BvB,OAAO;gBAAEC;YAAG;QACd;IACF;IAEA,MAAMuB,gBAAgBtB,SAAiB,EAAE;QACvC,MAAMuB,QAAQ,MAAM,IAAI,CAAC3B,MAAM,CAACO,MAAM,CAACqB,SAAS,CAAC;YAC/C1B,OAAO;gBAAEE;YAAU;YACnByB,MAAM;gBAAEpB,QAAQ;YAAK;YACrBqB,QAAQ;gBAAErB,QAAQ;YAAK;QACzB;QAEA,OAAO;YACLsB,eAAeJ,MAAME,IAAI,CAACpB,MAAM,IAAI;YACpCuB,cAAcL,MAAMG,MAAM,CAACrB,MAAM;QACnC;IACF;IAxGA,YAAY,AAAQT,MAAqB,CAAE;aAAvBA,SAAAA;IAAwB;AAyG9C"}
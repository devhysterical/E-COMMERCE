{"version":3,"sources":["../../src/users/users.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { Prisma, User } from '@prisma/client';\r\nimport * as bcrypt from 'bcrypt';\r\n\r\nexport interface UpdateProfileDto {\r\n  fullName?: string;\r\n  phone?: string;\r\n  address?: string;\r\n  dateOfBirth?: string; // ISO date string\r\n  avatarUrl?: string;\r\n}\r\n\r\nexport interface ChangePasswordDto {\r\n  currentPassword: string;\r\n  newPassword: string;\r\n}\r\n\r\n@Injectable()\r\nexport class UsersService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async findOne(email: string): Promise<User | null> {\r\n    return this.prisma.user.findUnique({\r\n      where: { email },\r\n    });\r\n  }\r\n\r\n  async create(data: Prisma.UserCreateInput): Promise<User> {\r\n    return this.prisma.user.create({\r\n      data,\r\n    });\r\n  }\r\n\r\n  async findById(id: string): Promise<User | null> {\r\n    return this.prisma.user.findUnique({\r\n      where: { id },\r\n    });\r\n  }\r\n\r\n  async updateProfile(userId: string, dto: UpdateProfileDto) {\r\n    const user = await this.findById(userId);\r\n    if (!user) {\r\n      throw new NotFoundException('Người dùng không tồn tại');\r\n    }\r\n\r\n    const updatedUser = await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: {\r\n        fullName: dto.fullName,\r\n        phone: dto.phone,\r\n        address: dto.address,\r\n        dateOfBirth: dto.dateOfBirth ? new Date(dto.dateOfBirth) : undefined,\r\n        avatarUrl: dto.avatarUrl,\r\n      },\r\n    });\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const { password, ...result } = updatedUser;\r\n    return result;\r\n  }\r\n\r\n  async changePassword(userId: string, dto: ChangePasswordDto) {\r\n    const user = await this.findById(userId);\r\n    if (!user) {\r\n      throw new NotFoundException('Người dùng không tồn tại');\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(\r\n      dto.currentPassword,\r\n      user.password,\r\n    );\r\n    if (!isPasswordValid) {\r\n      throw new NotFoundException('Mật khẩu hiện tại không đúng');\r\n    }\r\n\r\n    const hashedPassword = await bcrypt.hash(dto.newPassword, 10);\r\n    await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { password: hashedPassword },\r\n    });\r\n\r\n    return { message: 'Đổi mật khẩu thành công' };\r\n  }\r\n\r\n  async getProfile(userId: string) {\r\n    const user = await this.findById(userId);\r\n    if (!user) {\r\n      throw new NotFoundException('Người dùng không tồn tại');\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const { password, ...result } = user;\r\n    return result;\r\n  }\r\n\r\n  async findAll() {\r\n    return this.prisma.user.findMany({\r\n      where: { deletedAt: null },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        fullName: true,\r\n        role: true,\r\n        createdAt: true,\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async updateRole(userId: string, role: 'USER' | 'ADMIN') {\r\n    const user = await this.findById(userId);\r\n    if (!user) {\r\n      throw new NotFoundException('Người dùng không tồn tại');\r\n    }\r\n\r\n    const updatedUser = await this.prisma.user.update({\r\n      where: { id: userId },\r\n      data: { role },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        fullName: true,\r\n        role: true,\r\n        createdAt: true,\r\n      },\r\n    });\r\n\r\n    return updatedUser;\r\n  }\r\n}\r\n"],"names":["UsersService","findOne","email","prisma","user","findUnique","where","create","data","findById","id","updateProfile","userId","dto","NotFoundException","updatedUser","update","fullName","phone","address","dateOfBirth","Date","undefined","avatarUrl","password","result","changePassword","isPasswordValid","bcrypt","compare","currentPassword","hashedPassword","hash","newPassword","message","getProfile","findAll","findMany","deletedAt","select","role","createdAt","orderBy","updateRole"],"mappings":"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"}
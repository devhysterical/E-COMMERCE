{"version":3,"sources":["../../src/supabase/supabase.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\n@Injectable()\r\nexport class SupabaseService {\r\n  private supabase: ReturnType<typeof createClient>;\r\n\r\n  constructor() {\r\n    const supabaseUrl = process.env.SUPABASE_URL;\r\n    const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY;\r\n\r\n    if (!supabaseUrl || !supabaseServiceKey) {\r\n      throw new Error(\r\n        'Thiếu SUPABASE_URL hoặc SUPABASE_SERVICE_KEY trong .env',\r\n      );\r\n    }\r\n\r\n    this.supabase = createClient(supabaseUrl, supabaseServiceKey);\r\n  }\r\n\r\n  async uploadImage(\r\n    bucket: string,\r\n    file: Buffer,\r\n    fileName: string,\r\n    contentType: string,\r\n  ): Promise<{ url: string }> {\r\n    const { data, error } = await this.supabase.storage\r\n      .from(bucket)\r\n      .upload(fileName, file, {\r\n        contentType,\r\n        upsert: true,\r\n      });\r\n\r\n    if (error) {\r\n      throw new Error(`Lỗi upload: ${error.message}`);\r\n    }\r\n\r\n    const {\r\n      data: { publicUrl },\r\n    } = this.supabase.storage.from(bucket).getPublicUrl(data.path);\r\n\r\n    return { url: publicUrl };\r\n  }\r\n\r\n  async deleteImage(bucket: string, path: string): Promise<void> {\r\n    const { error } = await this.supabase.storage.from(bucket).remove([path]);\r\n\r\n    if (error) {\r\n      throw new Error(`Lỗi xóa file: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  // Auth methods\r\n  async sendPasswordResetEmail(\r\n    email: string,\r\n    redirectUrl: string,\r\n  ): Promise<void> {\r\n    const { error } = await this.supabase.auth.resetPasswordForEmail(email, {\r\n      redirectTo: redirectUrl,\r\n    });\r\n\r\n    if (error) {\r\n      throw new Error(`Lỗi gửi email reset: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  async getUserFromAccessToken(accessToken: string): Promise<{\r\n    id: string;\r\n    email: string;\r\n    fullName: string | null;\r\n    avatarUrl: string | null;\r\n  } | null> {\r\n    const { data, error } = await this.supabase.auth.getUser(accessToken);\r\n\r\n    if (error || !data.user) {\r\n      return null;\r\n    }\r\n\r\n    const metadata = (data.user.user_metadata || {}) as Record<\r\n      string,\r\n      string | undefined\r\n    >;\r\n\r\n    return {\r\n      id: data.user.id,\r\n      email: data.user.email || '',\r\n      fullName: metadata.full_name || metadata.name || null,\r\n      avatarUrl: metadata.avatar_url || metadata.picture || null,\r\n    };\r\n  }\r\n\r\n  // Gửi email OTP sử dụng Supabase Edge Function hoặc custom SMTP\r\n  // Tạm thời sử dụng console.log để demo, thực tế cần setup email template\r\n  async sendOtpEmail(email: string, otp: string): Promise<void> {\r\n    // Supabase không có built-in OTP email, nên ta sẽ tự gửi\r\n    // Option 1: Sử dụng Supabase Edge Function\r\n    // Option 2: Sử dụng nodemailer với SMTP\r\n    // Hiện tại log ra console để test, sau đó tích hợp thực tế\r\n\r\n    console.log(`[OTP] Sending OTP ${otp} to ${email}`);\r\n\r\n    // TODO: Tích hợp gửi email thực tế\r\n    // Ví dụ với nodemailer:\r\n    // await this.transporter.sendMail({\r\n    //   to: email,\r\n    //   subject: 'Mã xác thực đăng ký',\r\n    //   html: `<p>Mã OTP của bạn là: <strong>${otp}</strong></p>`,\r\n    // });\r\n\r\n    // Placeholder await để fix lint\r\n    await Promise.resolve();\r\n  }\r\n}\r\n"],"names":["SupabaseService","uploadImage","bucket","file","fileName","contentType","data","error","supabase","storage","from","upload","upsert","Error","message","publicUrl","getPublicUrl","path","url","deleteImage","remove","sendPasswordResetEmail","email","redirectUrl","auth","resetPasswordForEmail","redirectTo","getUserFromAccessToken","accessToken","getUser","user","metadata","user_metadata","id","fullName","full_name","name","avatarUrl","avatar_url","picture","sendOtpEmail","otp","console","log","Promise","resolve","supabaseUrl","process","env","SUPABASE_URL","supabaseServiceKey","SUPABASE_SERVICE_KEY","createClient"],"mappings":";;;;+BAIaA;;;eAAAA;;;wBAJc;4BACE;;;;;;;;;;AAGtB,IAAA,AAAMA,kBAAN,MAAMA;IAgBX,MAAMC,YACJC,MAAc,EACdC,IAAY,EACZC,QAAgB,EAChBC,WAAmB,EACO;QAC1B,MAAM,EAAEC,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAChDC,IAAI,CAACR,QACLS,MAAM,CAACP,UAAUD,MAAM;YACtBE;YACAO,QAAQ;QACV;QAEF,IAAIL,OAAO;YACT,MAAM,IAAIM,MAAM,CAAC,YAAY,EAAEN,MAAMO,OAAO,EAAE;QAChD;QAEA,MAAM,EACJR,MAAM,EAAES,SAAS,EAAE,EACpB,GAAG,IAAI,CAACP,QAAQ,CAACC,OAAO,CAACC,IAAI,CAACR,QAAQc,YAAY,CAACV,KAAKW,IAAI;QAE7D,OAAO;YAAEC,KAAKH;QAAU;IAC1B;IAEA,MAAMI,YAAYjB,MAAc,EAAEe,IAAY,EAAiB;QAC7D,MAAM,EAAEV,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACC,OAAO,CAACC,IAAI,CAACR,QAAQkB,MAAM,CAAC;YAACH;SAAK;QAExE,IAAIV,OAAO;YACT,MAAM,IAAIM,MAAM,CAAC,cAAc,EAAEN,MAAMO,OAAO,EAAE;QAClD;IACF;IAEA,eAAe;IACf,MAAMO,uBACJC,KAAa,EACbC,WAAmB,EACJ;QACf,MAAM,EAAEhB,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACgB,IAAI,CAACC,qBAAqB,CAACH,OAAO;YACtEI,YAAYH;QACd;QAEA,IAAIhB,OAAO;YACT,MAAM,IAAIM,MAAM,CAAC,qBAAqB,EAAEN,MAAMO,OAAO,EAAE;QACzD;IACF;IAEA,MAAMa,uBAAuBC,WAAmB,EAKtC;QACR,MAAM,EAAEtB,IAAI,EAAEC,KAAK,EAAE,GAAG,MAAM,IAAI,CAACC,QAAQ,CAACgB,IAAI,CAACK,OAAO,CAACD;QAEzD,IAAIrB,SAAS,CAACD,KAAKwB,IAAI,EAAE;YACvB,OAAO;QACT;QAEA,MAAMC,WAAYzB,KAAKwB,IAAI,CAACE,aAAa,IAAI,CAAC;QAK9C,OAAO;YACLC,IAAI3B,KAAKwB,IAAI,CAACG,EAAE;YAChBX,OAAOhB,KAAKwB,IAAI,CAACR,KAAK,IAAI;YAC1BY,UAAUH,SAASI,SAAS,IAAIJ,SAASK,IAAI,IAAI;YACjDC,WAAWN,SAASO,UAAU,IAAIP,SAASQ,OAAO,IAAI;QACxD;IACF;IAEA,gEAAgE;IAChE,yEAAyE;IACzE,MAAMC,aAAalB,KAAa,EAAEmB,GAAW,EAAiB;QAC5D,yDAAyD;QACzD,2CAA2C;QAC3C,wCAAwC;QACxC,2DAA2D;QAE3DC,QAAQC,GAAG,CAAC,CAAC,kBAAkB,EAAEF,IAAI,IAAI,EAAEnB,OAAO;QAElD,mCAAmC;QACnC,wBAAwB;QACxB,oCAAoC;QACpC,eAAe;QACf,oCAAoC;QACpC,+DAA+D;QAC/D,MAAM;QAEN,gCAAgC;QAChC,MAAMsB,QAAQC,OAAO;IACvB;IAxGA,aAAc;QACZ,MAAMC,cAAcC,QAAQC,GAAG,CAACC,YAAY;QAC5C,MAAMC,qBAAqBH,QAAQC,GAAG,CAACG,oBAAoB;QAE3D,IAAI,CAACL,eAAe,CAACI,oBAAoB;YACvC,MAAM,IAAIrC,MACR;QAEJ;QAEA,IAAI,CAACL,QAAQ,GAAG4C,IAAAA,wBAAY,EAACN,aAAaI;IAC5C;AA8FF"}
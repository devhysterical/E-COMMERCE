{"version":3,"sources":["../../src/upload/upload.controller.ts"],"sourcesContent":["import {\r\n  Controller,\r\n  Post,\r\n  UseGuards,\r\n  UseInterceptors,\r\n  UploadedFile,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { FileInterceptor } from '@nestjs/platform-express';\r\nimport { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';\r\nimport { RolesGuard } from '../common/guards/roles.guard';\r\nimport { Roles } from '../common/decorators/roles.decorator';\r\nimport { SupabaseService } from '../supabase/supabase.service';\r\nimport { randomUUID } from 'crypto';\r\n\r\nconst ALLOWED_MIME_TYPES = [\r\n  'image/jpeg',\r\n  'image/png',\r\n  'image/webp',\r\n  'image/gif',\r\n];\r\nconst MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB\r\n\r\ninterface UploadedFileType {\r\n  fieldname: string;\r\n  originalname: string;\r\n  encoding: string;\r\n  mimetype: string;\r\n  buffer: Buffer;\r\n  size: number;\r\n}\r\n\r\n@Controller('upload')\r\n@UseGuards(JwtAuthGuard, RolesGuard)\r\nexport class UploadController {\r\n  constructor(private readonly supabaseService: SupabaseService) {}\r\n\r\n  @Post('image')\r\n  @Roles('ADMIN')\r\n  @UseInterceptors(FileInterceptor('file'))\r\n  async uploadImage(@UploadedFile() file: UploadedFileType) {\r\n    if (!file) {\r\n      throw new BadRequestException('Không tìm thấy file');\r\n    }\r\n\r\n    if (!ALLOWED_MIME_TYPES.includes(file.mimetype)) {\r\n      throw new BadRequestException(\r\n        'Định dạng file không hợp lệ. Chỉ chấp nhận JPEG, PNG, WebP, GIF',\r\n      );\r\n    }\r\n\r\n    if (file.size > MAX_FILE_SIZE) {\r\n      throw new BadRequestException('File quá lớn. Tối đa 5MB');\r\n    }\r\n\r\n    // Tạo tên file unique\r\n    const nameParts = file.originalname.split('.');\r\n    const ext = nameParts.length > 1 ? nameParts.pop() : 'jpg';\r\n    const fileName = `products/${randomUUID()}.${ext}`;\r\n\r\n    const result = await this.supabaseService.uploadImage(\r\n      'products',\r\n      file.buffer,\r\n      fileName,\r\n      file.mimetype,\r\n    );\r\n\r\n    return result;\r\n  }\r\n}\r\n"],"names":["UploadController","ALLOWED_MIME_TYPES","MAX_FILE_SIZE","uploadImage","file","BadRequestException","includes","mimetype","size","nameParts","originalname","split","ext","length","pop","fileName","randomUUID","result","supabaseService","buffer"],"mappings":";;;;+BAkCaA;;;eAAAA;;;wBA3BN;iCACyB;8BACH;4BACF;gCACL;iCACU;wBACL;;;;;;;;;;;;;;;AAE3B,MAAMC,qBAAqB;IACzB;IACA;IACA;IACA;CACD;AACD,MAAMC,gBAAgB,IAAI,OAAO,MAAM,MAAM;AAatC,IAAA,AAAMF,mBAAN,MAAMA;IAGX,MAGMG,YAAY,AAAgBC,IAAsB,EAAE;QACxD,IAAI,CAACA,MAAM;YACT,MAAM,IAAIC,2BAAmB,CAAC;QAChC;QAEA,IAAI,CAACJ,mBAAmBK,QAAQ,CAACF,KAAKG,QAAQ,GAAG;YAC/C,MAAM,IAAIF,2BAAmB,CAC3B;QAEJ;QAEA,IAAID,KAAKI,IAAI,GAAGN,eAAe;YAC7B,MAAM,IAAIG,2BAAmB,CAAC;QAChC;QAEA,sBAAsB;QACtB,MAAMI,YAAYL,KAAKM,YAAY,CAACC,KAAK,CAAC;QAC1C,MAAMC,MAAMH,UAAUI,MAAM,GAAG,IAAIJ,UAAUK,GAAG,KAAK;QACrD,MAAMC,WAAW,CAAC,SAAS,EAAEC,IAAAA,kBAAU,IAAG,CAAC,EAAEJ,KAAK;QAElD,MAAMK,SAAS,MAAM,IAAI,CAACC,eAAe,CAACf,WAAW,CACnD,YACAC,KAAKe,MAAM,EACXJ,UACAX,KAAKG,QAAQ;QAGf,OAAOU;IACT;IAjCA,YAAY,AAAiBC,eAAgC,CAAE;aAAlCA,kBAAAA;IAAmC;AAkClE"}
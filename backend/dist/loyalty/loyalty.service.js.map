{"version":3,"sources":["../../src/loyalty/loyalty.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  BadRequestException,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CreateTierDto } from './dto/create-tier.dto';\r\nimport { UpdateTierDto } from './dto/update-tier.dto';\r\nimport { CreateRewardDto } from './dto/create-reward.dto';\r\nimport { UpdateRewardDto } from './dto/update-reward.dto';\r\nimport { AdjustPointsDto } from './dto/adjust-points.dto';\r\n\r\n@Injectable()\r\nexport class LoyaltyService {\r\n  constructor(private readonly prisma: PrismaService) {}\r\n\r\n  // --- Points Logic ---\r\n\r\n  async earnPoints(userId: string, orderId: string, amount: number) {\r\n    const tier = await this.getTier(userId);\r\n    const multiplier = tier?.pointMultiplier ?? 1.0;\r\n    const points = Math.floor((amount / 1000) * multiplier);\r\n\r\n    if (points <= 0) return;\r\n\r\n    // Check if points already earned for this order\r\n    const existing = await this.prisma.pointTransaction.findFirst({\r\n      where: { userId, orderId, type: 'EARN' },\r\n    });\r\n    if (existing) return;\r\n\r\n    const expiresAt = new Date();\r\n    expiresAt.setMonth(expiresAt.getMonth() + 12);\r\n\r\n    await this.prisma.$transaction([\r\n      this.prisma.pointTransaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'EARN',\r\n          points,\r\n          description: `Tích điểm đơn hàng #${orderId.slice(0, 8)}`,\r\n          orderId,\r\n          expiresAt,\r\n        },\r\n      }),\r\n      this.prisma.user.update({\r\n        where: { id: userId },\r\n        data: { totalPoints: { increment: points } },\r\n      }),\r\n    ]);\r\n\r\n    return { points, newTotal: (await this.getBalance(userId)).totalPoints };\r\n  }\r\n\r\n  async redeemPoints(userId: string, rewardId: string) {\r\n    const reward = await this.prisma.pointReward.findUnique({\r\n      where: { id: rewardId },\r\n    });\r\n    if (!reward) throw new NotFoundException('Phần thưởng không tồn tại');\r\n    if (!reward.isActive)\r\n      throw new BadRequestException('Phần thưởng đã ngừng hoạt động');\r\n\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n    });\r\n    if (!user) throw new NotFoundException('Người dùng không tồn tại');\r\n    if (user.totalPoints < reward.pointsCost)\r\n      throw new BadRequestException(\r\n        `Không đủ điểm. Cần ${reward.pointsCost}, hiện có ${user.totalPoints}`,\r\n      );\r\n\r\n    // Generate unique coupon code\r\n    const couponCode = `LOYALTY-${Date.now().toString(36).toUpperCase()}`;\r\n    const expiresAt = new Date();\r\n    expiresAt.setDate(expiresAt.getDate() + 30);\r\n\r\n    const result = await this.prisma.$transaction(async (tx) => {\r\n      // Deduct points\r\n      await tx.user.update({\r\n        where: { id: userId },\r\n        data: { totalPoints: { decrement: reward.pointsCost } },\r\n      });\r\n\r\n      // Create point transaction\r\n      await tx.pointTransaction.create({\r\n        data: {\r\n          userId,\r\n          type: 'REDEEM',\r\n          points: -reward.pointsCost,\r\n          description: `Đổi điểm: ${reward.name}`,\r\n        },\r\n      });\r\n\r\n      // Create coupon\r\n      const coupon = await tx.coupon.create({\r\n        data: {\r\n          code: couponCode,\r\n          description: `Loyalty Reward: ${reward.name}`,\r\n          discountType:\r\n            reward.rewardType === 'FREE_SHIPPING' ? 'FIXED' : 'FIXED',\r\n          discountValue: reward.couponValue ?? 0,\r\n          minOrderAmount: 0,\r\n          maxUses: 1,\r\n          startDate: new Date(),\r\n          expiresAt,\r\n          isActive: true,\r\n        },\r\n      });\r\n\r\n      return coupon;\r\n    });\r\n\r\n    return {\r\n      couponCode: result.code,\r\n      pointsUsed: reward.pointsCost,\r\n      remainingPoints: user.totalPoints - reward.pointsCost,\r\n    };\r\n  }\r\n\r\n  async getBalance(userId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { totalPoints: true },\r\n    });\r\n    if (!user) throw new NotFoundException('Người dùng không tồn tại');\r\n\r\n    const tier = await this.getTier(userId);\r\n\r\n    return {\r\n      totalPoints: user.totalPoints,\r\n      tier: tier ? { name: tier.name, multiplier: tier.pointMultiplier } : null,\r\n    };\r\n  }\r\n\r\n  async getTier(userId: string) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: userId },\r\n      select: { totalPoints: true },\r\n    });\r\n    if (!user) return null;\r\n\r\n    return this.prisma.loyaltyTier.findFirst({\r\n      where: { minPoints: { lte: user.totalPoints } },\r\n      orderBy: { minPoints: 'desc' },\r\n    });\r\n  }\r\n\r\n  async getHistory(userId: string) {\r\n    return this.prisma.pointTransaction.findMany({\r\n      where: { userId },\r\n      orderBy: { createdAt: 'desc' },\r\n      take: 50,\r\n    });\r\n  }\r\n\r\n  async adjustPoints(dto: AdjustPointsDto) {\r\n    const user = await this.prisma.user.findUnique({\r\n      where: { id: dto.userId },\r\n    });\r\n    if (!user) throw new NotFoundException('Người dùng không tồn tại');\r\n\r\n    await this.prisma.$transaction([\r\n      this.prisma.pointTransaction.create({\r\n        data: {\r\n          userId: dto.userId,\r\n          type: 'ADJUST',\r\n          points: dto.points,\r\n          description: dto.description,\r\n        },\r\n      }),\r\n      this.prisma.user.update({\r\n        where: { id: dto.userId },\r\n        data: { totalPoints: { increment: dto.points } },\r\n      }),\r\n    ]);\r\n\r\n    return { newTotal: user.totalPoints + dto.points };\r\n  }\r\n\r\n  // --- Tiers CRUD ---\r\n\r\n  async getAllTiers() {\r\n    return this.prisma.loyaltyTier.findMany({\r\n      orderBy: { minPoints: 'asc' },\r\n    });\r\n  }\r\n\r\n  async createTier(dto: CreateTierDto) {\r\n    return this.prisma.loyaltyTier.create({\r\n      data: {\r\n        name: dto.name,\r\n        minPoints: dto.minPoints,\r\n        pointMultiplier: dto.pointMultiplier ?? 1.0,\r\n        benefits: dto.benefits,\r\n      },\r\n    });\r\n  }\r\n\r\n  async updateTier(id: string, dto: UpdateTierDto) {\r\n    return this.prisma.loyaltyTier.update({\r\n      where: { id },\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async deleteTier(id: string) {\r\n    return this.prisma.loyaltyTier.delete({ where: { id } });\r\n  }\r\n\r\n  // --- Rewards CRUD ---\r\n\r\n  async getAllRewards() {\r\n    return this.prisma.pointReward.findMany({\r\n      orderBy: { pointsCost: 'asc' },\r\n    });\r\n  }\r\n\r\n  async getActiveRewards() {\r\n    return this.prisma.pointReward.findMany({\r\n      where: { isActive: true },\r\n      orderBy: { pointsCost: 'asc' },\r\n    });\r\n  }\r\n\r\n  async createReward(dto: CreateRewardDto) {\r\n    return this.prisma.pointReward.create({\r\n      data: {\r\n        name: dto.name,\r\n        pointsCost: dto.pointsCost,\r\n        rewardType: dto.rewardType,\r\n        couponValue: dto.couponValue,\r\n        isActive: dto.isActive ?? true,\r\n      },\r\n    });\r\n  }\r\n\r\n  async updateReward(id: string, dto: UpdateRewardDto) {\r\n    return this.prisma.pointReward.update({\r\n      where: { id },\r\n      data: dto,\r\n    });\r\n  }\r\n\r\n  async deleteReward(id: string) {\r\n    return this.prisma.pointReward.delete({ where: { id } });\r\n  }\r\n\r\n  // --- Admin: Users with points ---\r\n\r\n  async getUsersWithPoints() {\r\n    return this.prisma.user.findMany({\r\n      where: { totalPoints: { gt: 0 } },\r\n      select: {\r\n        id: true,\r\n        email: true,\r\n        fullName: true,\r\n        totalPoints: true,\r\n      },\r\n      orderBy: { totalPoints: 'desc' },\r\n    });\r\n  }\r\n}\r\n"],"names":["LoyaltyService","earnPoints","userId","orderId","amount","tier","getTier","multiplier","pointMultiplier","points","Math","floor","existing","prisma","pointTransaction","findFirst","where","type","expiresAt","Date","setMonth","getMonth","$transaction","create","data","description","slice","user","update","id","totalPoints","increment","newTotal","getBalance","redeemPoints","rewardId","reward","pointReward","findUnique","NotFoundException","isActive","BadRequestException","pointsCost","couponCode","now","toString","toUpperCase","setDate","getDate","result","tx","decrement","name","coupon","code","discountType","rewardType","discountValue","couponValue","minOrderAmount","maxUses","startDate","pointsUsed","remainingPoints","select","loyaltyTier","minPoints","lte","orderBy","getHistory","findMany","createdAt","take","adjustPoints","dto","getAllTiers","createTier","benefits","updateTier","deleteTier","delete","getAllRewards","getActiveRewards","createReward","updateReward","deleteReward","getUsersWithPoints","gt","email","fullName"],"mappings":"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"}
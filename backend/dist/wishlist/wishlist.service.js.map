{"version":3,"sources":["../../src/wishlist/wishlist.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\n\r\n@Injectable()\r\nexport class WishlistService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  // Lấy danh sách wishlist của user\r\n  async getWishlist(userId: string) {\r\n    const items = await this.prisma.wishlistItem.findMany({\r\n      where: { userId },\r\n      include: {\r\n        product: {\r\n          include: {\r\n            category: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n\r\n    return items.map((item) => ({\r\n      id: item.id,\r\n      productId: item.productId,\r\n      createdAt: item.createdAt,\r\n      product: item.product,\r\n    }));\r\n  }\r\n\r\n  // Thêm sản phẩm vào wishlist\r\n  async addToWishlist(userId: string, productId: string) {\r\n    // Kiểm tra product tồn tại\r\n    const product = await this.prisma.product.findUnique({\r\n      where: { id: productId, deletedAt: null },\r\n    });\r\n\r\n    if (!product) {\r\n      throw new NotFoundException('Sản phẩm không tồn tại');\r\n    }\r\n\r\n    // Thêm vào wishlist (upsert để tránh duplicate)\r\n    const item = await this.prisma.wishlistItem.upsert({\r\n      where: {\r\n        userId_productId: { userId, productId },\r\n      },\r\n      update: {}, // Không update gì nếu đã tồn tại\r\n      create: {\r\n        userId,\r\n        productId,\r\n      },\r\n      include: {\r\n        product: true,\r\n      },\r\n    });\r\n\r\n    return item;\r\n  }\r\n\r\n  // Xóa sản phẩm khỏi wishlist\r\n  async removeFromWishlist(userId: string, productId: string) {\r\n    const item = await this.prisma.wishlistItem.findUnique({\r\n      where: {\r\n        userId_productId: { userId, productId },\r\n      },\r\n    });\r\n\r\n    if (!item) {\r\n      throw new NotFoundException(\r\n        'Sản phẩm không có trong danh sách yêu thích',\r\n      );\r\n    }\r\n\r\n    await this.prisma.wishlistItem.delete({\r\n      where: { id: item.id },\r\n    });\r\n\r\n    return { message: 'Đã xóa khỏi danh sách yêu thích' };\r\n  }\r\n\r\n  // Kiểm tra sản phẩm có trong wishlist không\r\n  async isInWishlist(userId: string, productId: string): Promise<boolean> {\r\n    const item = await this.prisma.wishlistItem.findUnique({\r\n      where: {\r\n        userId_productId: { userId, productId },\r\n      },\r\n    });\r\n\r\n    return !!item;\r\n  }\r\n\r\n  // Toggle wishlist (thêm nếu chưa có, xóa nếu đã có)\r\n  async toggleWishlist(userId: string, productId: string) {\r\n    const isInWishlist = await this.isInWishlist(userId, productId);\r\n\r\n    if (isInWishlist) {\r\n      await this.removeFromWishlist(userId, productId);\r\n      return { inWishlist: false, message: 'Đã xóa khỏi danh sách yêu thích' };\r\n    } else {\r\n      await this.addToWishlist(userId, productId);\r\n      return { inWishlist: true, message: 'Đã thêm vào danh sách yêu thích' };\r\n    }\r\n  }\r\n}\r\n"],"names":["WishlistService","getWishlist","userId","items","prisma","wishlistItem","findMany","where","include","product","category","orderBy","createdAt","map","item","id","productId","addToWishlist","findUnique","deletedAt","NotFoundException","upsert","userId_productId","update","create","removeFromWishlist","delete","message","isInWishlist","toggleWishlist","inWishlist"],"mappings":";;;;+BAIaA;;;eAAAA;;;wBAJiC;+BAChB;;;;;;;;;;AAGvB,IAAA,AAAMA,kBAAN,MAAMA;IAGX,kCAAkC;IAClC,MAAMC,YAAYC,MAAc,EAAE;QAChC,MAAMC,QAAQ,MAAM,IAAI,CAACC,MAAM,CAACC,YAAY,CAACC,QAAQ,CAAC;YACpDC,OAAO;gBAAEL;YAAO;YAChBM,SAAS;gBACPC,SAAS;oBACPD,SAAS;wBACPE,UAAU;oBACZ;gBACF;YACF;YACAC,SAAS;gBAAEC,WAAW;YAAO;QAC/B;QAEA,OAAOT,MAAMU,GAAG,CAAC,CAACC,OAAU,CAAA;gBAC1BC,IAAID,KAAKC,EAAE;gBACXC,WAAWF,KAAKE,SAAS;gBACzBJ,WAAWE,KAAKF,SAAS;gBACzBH,SAASK,KAAKL,OAAO;YACvB,CAAA;IACF;IAEA,6BAA6B;IAC7B,MAAMQ,cAAcf,MAAc,EAAEc,SAAiB,EAAE;QACrD,2BAA2B;QAC3B,MAAMP,UAAU,MAAM,IAAI,CAACL,MAAM,CAACK,OAAO,CAACS,UAAU,CAAC;YACnDX,OAAO;gBAAEQ,IAAIC;gBAAWG,WAAW;YAAK;QAC1C;QAEA,IAAI,CAACV,SAAS;YACZ,MAAM,IAAIW,yBAAiB,CAAC;QAC9B;QAEA,gDAAgD;QAChD,MAAMN,OAAO,MAAM,IAAI,CAACV,MAAM,CAACC,YAAY,CAACgB,MAAM,CAAC;YACjDd,OAAO;gBACLe,kBAAkB;oBAAEpB;oBAAQc;gBAAU;YACxC;YACAO,QAAQ,CAAC;YACTC,QAAQ;gBACNtB;gBACAc;YACF;YACAR,SAAS;gBACPC,SAAS;YACX;QACF;QAEA,OAAOK;IACT;IAEA,6BAA6B;IAC7B,MAAMW,mBAAmBvB,MAAc,EAAEc,SAAiB,EAAE;QAC1D,MAAMF,OAAO,MAAM,IAAI,CAACV,MAAM,CAACC,YAAY,CAACa,UAAU,CAAC;YACrDX,OAAO;gBACLe,kBAAkB;oBAAEpB;oBAAQc;gBAAU;YACxC;QACF;QAEA,IAAI,CAACF,MAAM;YACT,MAAM,IAAIM,yBAAiB,CACzB;QAEJ;QAEA,MAAM,IAAI,CAAChB,MAAM,CAACC,YAAY,CAACqB,MAAM,CAAC;YACpCnB,OAAO;gBAAEQ,IAAID,KAAKC,EAAE;YAAC;QACvB;QAEA,OAAO;YAAEY,SAAS;QAAkC;IACtD;IAEA,4CAA4C;IAC5C,MAAMC,aAAa1B,MAAc,EAAEc,SAAiB,EAAoB;QACtE,MAAMF,OAAO,MAAM,IAAI,CAACV,MAAM,CAACC,YAAY,CAACa,UAAU,CAAC;YACrDX,OAAO;gBACLe,kBAAkB;oBAAEpB;oBAAQc;gBAAU;YACxC;QACF;QAEA,OAAO,CAAC,CAACF;IACX;IAEA,oDAAoD;IACpD,MAAMe,eAAe3B,MAAc,EAAEc,SAAiB,EAAE;QACtD,MAAMY,eAAe,MAAM,IAAI,CAACA,YAAY,CAAC1B,QAAQc;QAErD,IAAIY,cAAc;YAChB,MAAM,IAAI,CAACH,kBAAkB,CAACvB,QAAQc;YACtC,OAAO;gBAAEc,YAAY;gBAAOH,SAAS;YAAkC;QACzE,OAAO;YACL,MAAM,IAAI,CAACV,aAAa,CAACf,QAAQc;YACjC,OAAO;gBAAEc,YAAY;gBAAMH,SAAS;YAAkC;QACxE;IACF;IAhGA,YAAY,AAAQvB,MAAqB,CAAE;aAAvBA,SAAAA;IAAwB;AAiG9C"}
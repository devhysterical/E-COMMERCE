{"version":3,"sources":["../../src/orders/invoice.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport PDFDocument from 'pdfkit';\r\nimport { Response } from 'express';\r\n\r\n@Injectable()\r\nexport class InvoiceService {\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async generateInvoice(\r\n    orderId: string,\r\n    userId: string,\r\n    res: Response,\r\n  ): Promise<void> {\r\n    // Lấy thông tin đơn hàng\r\n    const order = await this.prisma.order.findFirst({\r\n      where: { id: orderId, userId, deletedAt: null },\r\n      include: {\r\n        user: {\r\n          select: { id: true, email: true, fullName: true, phone: true },\r\n        },\r\n        orderItems: {\r\n          include: {\r\n            product: {\r\n              select: { id: true, name: true, price: true },\r\n            },\r\n          },\r\n        },\r\n        coupon: {\r\n          select: { code: true, discountType: true, discountValue: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!order) {\r\n      throw new NotFoundException('Đơn hàng không tồn tại');\r\n    }\r\n\r\n    // Tạo PDF document\r\n    const doc = new PDFDocument({\r\n      size: 'A4',\r\n      margin: 50,\r\n      info: {\r\n        Title: `Hóa đơn #${orderId.slice(0, 8).toUpperCase()}`,\r\n        Author: 'L-TECH Solutions',\r\n      },\r\n    });\r\n\r\n    // Set response headers\r\n    res.set({\r\n      'Content-Type': 'application/pdf',\r\n      'Content-Disposition': `attachment; filename=\"invoice-${orderId.slice(0, 8)}.pdf\"`,\r\n    });\r\n\r\n    // Pipe PDF to response\r\n    doc.pipe(res);\r\n\r\n    // ========== HEADER ==========\r\n    doc\r\n      .fontSize(24)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#4F46E5')\r\n      .text('L-TECH SOLUTIONS', 50, 50);\r\n\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica')\r\n      .fillColor('#64748B')\r\n      .text('Premium Electronics & Technology', 50, 80);\r\n\r\n    // Invoice title\r\n    doc\r\n      .fontSize(28)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#1E293B')\r\n      .text('HOA DON', 400, 50, { align: 'right' });\r\n\r\n    doc\r\n      .fontSize(12)\r\n      .font('Helvetica')\r\n      .fillColor('#64748B')\r\n      .text(`#${orderId.slice(0, 8).toUpperCase()}`, 400, 85, {\r\n        align: 'right',\r\n      });\r\n\r\n    // Divider\r\n    doc.moveTo(50, 110).lineTo(545, 110).stroke('#E2E8F0');\r\n\r\n    // ========== ORDER INFO ==========\r\n    const infoY = 130;\r\n\r\n    // Left column - Customer info\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#64748B')\r\n      .text('KHACH HANG:', 50, infoY);\r\n\r\n    doc\r\n      .fontSize(11)\r\n      .font('Helvetica')\r\n      .fillColor('#1E293B')\r\n      .text(order.user?.fullName || 'N/A', 50, infoY + 15)\r\n      .text(order.user?.email || '', 50, infoY + 30)\r\n      .text(order.phone || '', 50, infoY + 45);\r\n\r\n    // Right column - Order info\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#64748B')\r\n      .text('THONG TIN DON HANG:', 350, infoY);\r\n\r\n    const orderDate = new Date(order.createdAt).toLocaleDateString('vi-VN', {\r\n      year: 'numeric',\r\n      month: 'long',\r\n      day: 'numeric',\r\n    });\r\n\r\n    doc\r\n      .fontSize(11)\r\n      .font('Helvetica')\r\n      .fillColor('#1E293B')\r\n      .text(`Ngay dat: ${orderDate}`, 350, infoY + 15)\r\n      .text(`Trang thai: ${this.getStatusLabel(order.status)}`, 350, infoY + 30)\r\n      .text(\r\n        `Thanh toan: ${order.paymentMethod === 'COD' ? 'COD' : 'MoMo'}`,\r\n        350,\r\n        infoY + 45,\r\n      );\r\n\r\n    // Shipping address\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#64748B')\r\n      .text('DIA CHI GIAO HANG:', 50, infoY + 75);\r\n\r\n    doc\r\n      .fontSize(11)\r\n      .font('Helvetica')\r\n      .fillColor('#1E293B')\r\n      .text(order.address, 50, infoY + 90, { width: 300 });\r\n\r\n    // ========== ORDER ITEMS TABLE ==========\r\n    const tableTop = 280;\r\n\r\n    // Table header\r\n    doc.rect(50, tableTop, 495, 25).fill('#F1F5F9');\r\n\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#475569')\r\n      .text('SAN PHAM', 60, tableTop + 8)\r\n      .text('SO LUONG', 320, tableTop + 8, { width: 70, align: 'center' })\r\n      .text('DON GIA', 390, tableTop + 8, { width: 70, align: 'right' })\r\n      .text('THANH TIEN', 460, tableTop + 8, { width: 75, align: 'right' });\r\n\r\n    // Table rows\r\n    let rowY = tableTop + 35;\r\n    let subtotal = 0;\r\n\r\n    for (const item of order.orderItems) {\r\n      const itemTotal = item.price * item.quantity;\r\n      subtotal += itemTotal;\r\n\r\n      doc\r\n        .fontSize(10)\r\n        .font('Helvetica')\r\n        .fillColor('#1E293B')\r\n        .text(item.product.name, 60, rowY, { width: 250 })\r\n        .text(item.quantity.toString(), 320, rowY, {\r\n          width: 70,\r\n          align: 'center',\r\n        })\r\n        .text(this.formatPrice(item.price), 390, rowY, {\r\n          width: 70,\r\n          align: 'right',\r\n        })\r\n        .text(this.formatPrice(itemTotal), 460, rowY, {\r\n          width: 75,\r\n          align: 'right',\r\n        });\r\n\r\n      rowY += 25;\r\n\r\n      // Draw row separator\r\n      doc\r\n        .moveTo(50, rowY - 5)\r\n        .lineTo(545, rowY - 5)\r\n        .stroke('#E2E8F0');\r\n    }\r\n\r\n    // ========== TOTALS ==========\r\n    const totalsY = rowY + 20;\r\n\r\n    // Subtotal\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica')\r\n      .fillColor('#64748B')\r\n      .text('Tam tinh:', 380, totalsY)\r\n      .fillColor('#1E293B')\r\n      .text(this.formatPrice(subtotal), 460, totalsY, {\r\n        width: 75,\r\n        align: 'right',\r\n      });\r\n\r\n    // Discount (if any)\r\n    if (order.discountAmount > 0) {\r\n      doc\r\n        .fontSize(10)\r\n        .font('Helvetica')\r\n        .fillColor('#64748B')\r\n        .text('Giam gia:', 380, totalsY + 20)\r\n        .fillColor('#22C55E')\r\n        .text(`-${this.formatPrice(order.discountAmount)}`, 460, totalsY + 20, {\r\n          width: 75,\r\n          align: 'right',\r\n        });\r\n    }\r\n\r\n    // Shipping\r\n    doc\r\n      .fontSize(10)\r\n      .font('Helvetica')\r\n      .fillColor('#64748B')\r\n      .text(\r\n        'Phi van chuyen:',\r\n        380,\r\n        totalsY + (order.discountAmount > 0 ? 40 : 20),\r\n      )\r\n      .fillColor('#22C55E')\r\n      .text('Mien phi', 460, totalsY + (order.discountAmount > 0 ? 40 : 20), {\r\n        width: 75,\r\n        align: 'right',\r\n      });\r\n\r\n    // Total\r\n    const totalLineY = totalsY + (order.discountAmount > 0 ? 70 : 50);\r\n    doc.moveTo(350, totalLineY).lineTo(545, totalLineY).stroke('#E2E8F0');\r\n\r\n    doc\r\n      .fontSize(14)\r\n      .font('Helvetica-Bold')\r\n      .fillColor('#1E293B')\r\n      .text('TONG CONG:', 380, totalLineY + 10)\r\n      .fillColor('#4F46E5')\r\n      .text(this.formatPrice(order.totalAmount), 460, totalLineY + 10, {\r\n        width: 75,\r\n        align: 'right',\r\n      });\r\n\r\n    // ========== FOOTER ==========\r\n    const footerY = 750;\r\n\r\n    doc.moveTo(50, footerY).lineTo(545, footerY).stroke('#E2E8F0');\r\n\r\n    doc\r\n      .fontSize(9)\r\n      .font('Helvetica')\r\n      .fillColor('#94A3B8')\r\n      .text(\r\n        'Cam on quy khach da mua hang tai L-TECH Solutions!',\r\n        50,\r\n        footerY + 15,\r\n        {\r\n          align: 'center',\r\n          width: 495,\r\n        },\r\n      )\r\n      .text(\r\n        'Moi thac mac xin lien he: support@ltech.vn | Hotline: 1900-xxxx',\r\n        50,\r\n        footerY + 30,\r\n        { align: 'center', width: 495 },\r\n      );\r\n\r\n    // Finalize PDF\r\n    doc.end();\r\n  }\r\n\r\n  private formatPrice(amount: number): string {\r\n    return new Intl.NumberFormat('vi-VN').format(amount) + ' d';\r\n  }\r\n\r\n  private getStatusLabel(status: string): string {\r\n    const labels: Record<string, string> = {\r\n      PENDING: 'Cho xu ly',\r\n      PROCESSING: 'Dang xu ly',\r\n      SHIPPED: 'Dang giao',\r\n      DELIVERED: 'Da giao',\r\n      CANCELLED: 'Da huy',\r\n    };\r\n    return labels[status] || status;\r\n  }\r\n}\r\n"],"names":["InvoiceService","generateInvoice","orderId","userId","res","order","prisma","findFirst","where","id","deletedAt","include","user","select","email","fullName","phone","orderItems","product","name","price","coupon","code","discountType","discountValue","NotFoundException","doc","PDFDocument","size","margin","info","Title","slice","toUpperCase","Author","set","pipe","fontSize","font","fillColor","text","align","moveTo","lineTo","stroke","infoY","orderDate","Date","createdAt","toLocaleDateString","year","month","day","getStatusLabel","status","paymentMethod","address","width","tableTop","rect","fill","rowY","subtotal","item","itemTotal","quantity","toString","formatPrice","totalsY","discountAmount","totalLineY","totalAmount","footerY","end","amount","Intl","NumberFormat","format","labels","PENDING","PROCESSING","SHIPPED","DELIVERED","CANCELLED"],"mappings":"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"}
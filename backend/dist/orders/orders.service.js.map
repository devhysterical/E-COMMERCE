{"version":3,"sources":["../../src/orders/orders.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  BadRequestException,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CartsService } from '../carts/carts.service';\r\nimport { EmailService } from '../email/email.service';\r\nimport { ShippingService } from '../shipping/shipping.service';\r\nimport { OrderStatus, PaymentMethod, PaymentStatus } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class OrdersService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private cartsService: CartsService,\r\n    private emailService: EmailService,\r\n    private shippingService: ShippingService,\r\n  ) {}\r\n\r\n  async createOrder(\r\n    userId: string,\r\n    address: string,\r\n    phone: string,\r\n    paymentMethod: PaymentMethod = 'COD',\r\n    couponId?: string,\r\n    province?: string,\r\n  ) {\r\n    const cart = await this.cartsService.getCart(userId);\r\n    if (!cart.cartItems.length) {\r\n      throw new BadRequestException('Giỏ hàng trống');\r\n    }\r\n\r\n    const totalAmount = cart.cartItems.reduce(\r\n      (sum, item) => sum + item.product.price * item.quantity,\r\n      0,\r\n    );\r\n\r\n    // Xử lý coupon nếu có\r\n    let discountAmount = 0;\r\n    let validCouponId: string | undefined = undefined;\r\n\r\n    if (couponId) {\r\n      const coupon = await this.prisma.coupon.findUnique({\r\n        where: { id: couponId },\r\n      });\r\n\r\n      if (coupon && coupon.isActive) {\r\n        // Kiểm tra user đã dùng coupon chưa\r\n        const existingUsage = await this.prisma.couponUsage.findUnique({\r\n          where: { couponId_userId: { couponId, userId } },\r\n        });\r\n\r\n        if (!existingUsage) {\r\n          // Tính discount\r\n          if (coupon.discountType === 'PERCENTAGE') {\r\n            discountAmount = Math.floor(\r\n              (totalAmount * coupon.discountValue) / 100,\r\n            );\r\n            if (coupon.maxDiscount && discountAmount > coupon.maxDiscount) {\r\n              discountAmount = coupon.maxDiscount;\r\n            }\r\n          } else {\r\n            discountAmount = coupon.discountValue;\r\n            if (discountAmount > totalAmount) {\r\n              discountAmount = totalAmount;\r\n            }\r\n          }\r\n          validCouponId = couponId;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Tính phí vận chuyển\r\n    let shippingFee = 0;\r\n    if (province) {\r\n      const shippingResult = await this.shippingService.calculateFee(\r\n        province,\r\n        totalAmount - discountAmount,\r\n      );\r\n      shippingFee = shippingResult.fee;\r\n    }\r\n\r\n    const finalAmount = totalAmount - discountAmount + shippingFee;\r\n\r\n    // Sử dụng transaction để đảm bảo tính toàn vẹn\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // 1. Tạo Order\r\n      const order = await tx.order.create({\r\n        data: {\r\n          userId,\r\n          totalAmount: finalAmount,\r\n          discountAmount,\r\n          shippingFee,\r\n          couponId: validCouponId,\r\n          address,\r\n          phone,\r\n          paymentMethod,\r\n          paymentStatus: paymentMethod === 'COD' ? 'PENDING' : 'PENDING',\r\n        },\r\n      });\r\n\r\n      // 2. Tạo OrderItems và Cập nhật Stock\r\n      for (const item of cart.cartItems) {\r\n        if (item.product.stock < item.quantity) {\r\n          throw new BadRequestException(\r\n            `Sản phẩm ${item.product.name} không đủ tồn kho`,\r\n          );\r\n        }\r\n\r\n        await tx.orderItem.create({\r\n          data: {\r\n            orderId: order.id,\r\n            productId: item.productId,\r\n            quantity: item.quantity,\r\n            price: item.product.price,\r\n          },\r\n        });\r\n\r\n        await tx.product.update({\r\n          where: { id: item.productId },\r\n          data: { stock: item.product.stock - item.quantity },\r\n        });\r\n      }\r\n\r\n      // 3. Xóa giỏ hàng\r\n      await tx.cartItem.deleteMany({\r\n        where: { cartId: cart.id },\r\n      });\r\n\r\n      // 4. Ghi nhận sử dụng coupon\r\n      if (validCouponId) {\r\n        await tx.couponUsage.create({\r\n          data: {\r\n            couponId: validCouponId,\r\n            userId,\r\n            orderId: order.id,\r\n          },\r\n        });\r\n\r\n        await tx.coupon.update({\r\n          where: { id: validCouponId },\r\n          data: { usedCount: { increment: 1 } },\r\n        });\r\n      }\r\n\r\n      // 5. Gửi email xác nhận đơn hàng\r\n      const user = await tx.user.findUnique({ where: { id: userId } });\r\n      if (user?.email) {\r\n        void this.emailService.sendOrderConfirmationEmail(user.email, {\r\n          orderId: order.id,\r\n          totalAmount: finalAmount,\r\n          discountAmount,\r\n          items: cart.cartItems.map((item) => ({\r\n            name: item.product.name,\r\n            quantity: item.quantity,\r\n            price: item.product.price * item.quantity,\r\n          })),\r\n          address,\r\n          paymentMethod,\r\n        });\r\n      }\r\n\r\n      return order;\r\n    });\r\n  }\r\n\r\n  async findAll(userId: string) {\r\n    return this.prisma.order.findMany({\r\n      where: { userId, deletedAt: null },\r\n      include: {\r\n        orderItems: {\r\n          include: { product: true },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async findOne(id: string, userId: string) {\r\n    return this.prisma.order.findFirst({\r\n      where: { id, userId, deletedAt: null },\r\n      include: {\r\n        orderItems: {\r\n          include: { product: true },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Admin APIs\r\n  async findAllAdmin() {\r\n    return this.prisma.order.findMany({\r\n      where: { deletedAt: null },\r\n      include: {\r\n        user: {\r\n          select: { id: true, email: true, fullName: true },\r\n        },\r\n        orderItems: {\r\n          include: {\r\n            product: { select: { id: true, name: true, imageUrl: true } },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async updateStatus(id: string, status: OrderStatus) {\r\n    const order = await this.prisma.order.findUnique({\r\n      where: { id },\r\n      include: {\r\n        orderItems: {\r\n          include: { product: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!order) {\r\n      throw new NotFoundException('Đơn hàng không tồn tại');\r\n    }\r\n\r\n    // Nếu chuyển sang CANCELLED và đơn hàng trước đó không phải CANCELLED\r\n    // thì hoàn lại tồn kho\r\n    if (status === 'CANCELLED' && order.status !== 'CANCELLED') {\r\n      return this.prisma.$transaction(async (tx) => {\r\n        // Hoàn lại stock cho từng sản phẩm\r\n        for (const item of order.orderItems) {\r\n          await tx.product.update({\r\n            where: { id: item.productId },\r\n            data: { stock: { increment: item.quantity } },\r\n          });\r\n        }\r\n\r\n        // Cập nhật status đơn hàng\r\n        return tx.order.update({\r\n          where: { id },\r\n          data: { status },\r\n          include: {\r\n            user: {\r\n              select: { id: true, email: true, fullName: true },\r\n            },\r\n            orderItems: {\r\n              include: { product: { select: { id: true, name: true } } },\r\n            },\r\n          },\r\n        });\r\n      });\r\n    }\r\n\r\n    // Nếu không phải CANCELLED, chỉ cập nhật status bình thường\r\n    const updatedOrder = await this.prisma.order.update({\r\n      where: { id },\r\n      data: { status },\r\n      include: {\r\n        user: {\r\n          select: { id: true, email: true, fullName: true },\r\n        },\r\n        orderItems: {\r\n          include: { product: { select: { id: true, name: true } } },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Gửi email thông báo cập nhật status\r\n    if (updatedOrder.user?.email) {\r\n      const statusLabels: Record<string, string> = {\r\n        PENDING: 'Chờ xử lý',\r\n        PROCESSING: 'Đang xử lý',\r\n        SHIPPED: 'Đang giao hàng',\r\n        DELIVERED: 'Đã giao hàng',\r\n        CANCELLED: 'Đã hủy',\r\n      };\r\n      void this.emailService.sendOrderStatusUpdateEmail(\r\n        updatedOrder.user.email,\r\n        {\r\n          orderId: id,\r\n          status,\r\n          statusLabel: statusLabels[status] || status,\r\n        },\r\n      );\r\n    }\r\n\r\n    return updatedOrder;\r\n  }\r\n\r\n  async getStats() {\r\n    const [totalOrders, totalRevenue, ordersByStatus] = await Promise.all([\r\n      this.prisma.order.count({ where: { deletedAt: null } }),\r\n      this.prisma.order.aggregate({\r\n        where: { deletedAt: null, status: { not: 'CANCELLED' } },\r\n        _sum: { totalAmount: true },\r\n      }),\r\n      this.prisma.order.groupBy({\r\n        by: ['status'],\r\n        _count: { status: true },\r\n        where: { deletedAt: null },\r\n      }),\r\n    ]);\r\n\r\n    return {\r\n      totalOrders,\r\n      totalRevenue: totalRevenue._sum.totalAmount || 0,\r\n      ordersByStatus: ordersByStatus.reduce(\r\n        (acc, item) => {\r\n          acc[item.status] = item._count.status;\r\n          return acc;\r\n        },\r\n        {} as Record<string, number>,\r\n      ),\r\n    };\r\n  }\r\n\r\n  async updatePaymentStatus(\r\n    orderId: string,\r\n    status: PaymentStatus,\r\n    momoTransId: string | null,\r\n  ) {\r\n    return this.prisma.order.update({\r\n      where: { id: orderId },\r\n      data: {\r\n        paymentStatus: status,\r\n        momoTransId: momoTransId,\r\n      },\r\n    });\r\n  }\r\n}\r\n"],"names":["OrdersService","createOrder","userId","address","phone","paymentMethod","couponId","province","cart","cartsService","getCart","cartItems","length","BadRequestException","totalAmount","reduce","sum","item","product","price","quantity","discountAmount","validCouponId","undefined","coupon","prisma","findUnique","where","id","isActive","existingUsage","couponUsage","couponId_userId","discountType","Math","floor","discountValue","maxDiscount","shippingFee","shippingResult","shippingService","calculateFee","fee","finalAmount","$transaction","tx","order","create","data","paymentStatus","stock","name","orderItem","orderId","productId","update","cartItem","deleteMany","cartId","usedCount","increment","user","email","emailService","sendOrderConfirmationEmail","items","map","findAll","findMany","deletedAt","include","orderItems","orderBy","createdAt","findOne","findFirst","findAllAdmin","select","fullName","imageUrl","updateStatus","status","NotFoundException","updatedOrder","statusLabels","PENDING","PROCESSING","SHIPPED","DELIVERED","CANCELLED","sendOrderStatusUpdateEmail","statusLabel","getStats","totalOrders","totalRevenue","ordersByStatus","Promise","all","count","aggregate","not","_sum","groupBy","by","_count","acc","updatePaymentStatus","momoTransId"],"mappings":"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"}
{"version":3,"sources":["../../src/orders/orders.service.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  BadRequestException,\r\n  NotFoundException,\r\n} from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { CartsService } from '../carts/carts.service';\r\nimport { EmailService } from '../email/email.service';\r\nimport { ShippingService } from '../shipping/shipping.service';\r\nimport { FlashSaleService } from '../flash-sale/flash-sale.service';\r\nimport { LoyaltyService } from '../loyalty/loyalty.service';\r\nimport { OrderStatus, PaymentMethod, PaymentStatus } from '@prisma/client';\r\n\r\n@Injectable()\r\nexport class OrdersService {\r\n  constructor(\r\n    private prisma: PrismaService,\r\n    private cartsService: CartsService,\r\n    private emailService: EmailService,\r\n    private shippingService: ShippingService,\r\n    private flashSaleService: FlashSaleService,\r\n    private loyaltyService: LoyaltyService,\r\n  ) {}\r\n\r\n  async createOrder(\r\n    userId: string,\r\n    address: string,\r\n    phone: string,\r\n    paymentMethod: PaymentMethod = 'COD',\r\n    couponId?: string,\r\n    province?: string,\r\n  ) {\r\n    const cart = await this.cartsService.getCart(userId);\r\n    if (!cart.cartItems.length) {\r\n      throw new BadRequestException('Giỏ hàng trống');\r\n    }\r\n\r\n    // Kiểm tra flash sale price cho từng sản phẩm\r\n    const flashSaleMap = new Map<\r\n      string,\r\n      { salePrice: number; flashSaleItemId: string }\r\n    >();\r\n\r\n    for (const item of cart.cartItems) {\r\n      const flashSaleInfo = await this.flashSaleService.checkFlashSalePrice(\r\n        item.productId,\r\n        userId,\r\n      );\r\n      if (flashSaleInfo) {\r\n        flashSaleMap.set(item.productId, flashSaleInfo);\r\n      }\r\n    }\r\n\r\n    const totalAmount = cart.cartItems.reduce((sum, item) => {\r\n      const flashInfo = flashSaleMap.get(item.productId);\r\n      const price = flashInfo ? flashInfo.salePrice : item.product.price;\r\n      return sum + price * item.quantity;\r\n    }, 0);\r\n\r\n    // Xử lý coupon nếu có\r\n    let discountAmount = 0;\r\n    let validCouponId: string | undefined = undefined;\r\n\r\n    if (couponId) {\r\n      const coupon = await this.prisma.coupon.findUnique({\r\n        where: { id: couponId },\r\n      });\r\n\r\n      if (coupon && coupon.isActive) {\r\n        // Kiểm tra user đã dùng coupon chưa\r\n        const existingUsage = await this.prisma.couponUsage.findUnique({\r\n          where: { couponId_userId: { couponId, userId } },\r\n        });\r\n\r\n        if (!existingUsage) {\r\n          // Tính discount\r\n          if (coupon.discountType === 'PERCENTAGE') {\r\n            discountAmount = Math.floor(\r\n              (totalAmount * coupon.discountValue) / 100,\r\n            );\r\n            if (coupon.maxDiscount && discountAmount > coupon.maxDiscount) {\r\n              discountAmount = coupon.maxDiscount;\r\n            }\r\n          } else {\r\n            discountAmount = coupon.discountValue;\r\n            if (discountAmount > totalAmount) {\r\n              discountAmount = totalAmount;\r\n            }\r\n          }\r\n          validCouponId = couponId;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Tính phí vận chuyển\r\n    let shippingFee = 0;\r\n    if (province) {\r\n      const shippingResult = await this.shippingService.calculateFee(\r\n        province,\r\n        totalAmount - discountAmount,\r\n      );\r\n      shippingFee = shippingResult.fee;\r\n    }\r\n\r\n    const finalAmount = totalAmount - discountAmount + shippingFee;\r\n\r\n    // Sử dụng transaction để đảm bảo tính toàn vẹn\r\n    return this.prisma.$transaction(async (tx) => {\r\n      // 1. Tạo Order\r\n      const order = await tx.order.create({\r\n        data: {\r\n          userId,\r\n          totalAmount: finalAmount,\r\n          discountAmount,\r\n          shippingFee,\r\n          couponId: validCouponId,\r\n          address,\r\n          phone,\r\n          paymentMethod,\r\n          paymentStatus: paymentMethod === 'COD' ? 'PENDING' : 'PENDING',\r\n        },\r\n      });\r\n\r\n      // 2. Tạo OrderItems và Cập nhật Stock\r\n      for (const item of cart.cartItems) {\r\n        if (item.product.stock < item.quantity) {\r\n          throw new BadRequestException(\r\n            `Sản phẩm ${item.product.name} không đủ tồn kho`,\r\n          );\r\n        }\r\n\r\n        await tx.orderItem.create({\r\n          data: {\r\n            orderId: order.id,\r\n            productId: item.productId,\r\n            quantity: item.quantity,\r\n            price:\r\n              flashSaleMap.get(item.productId)?.salePrice ?? item.product.price,\r\n          },\r\n        });\r\n\r\n        await tx.product.update({\r\n          where: { id: item.productId },\r\n          data: { stock: item.product.stock - item.quantity },\r\n        });\r\n      }\r\n\r\n      // 3. Cập nhật soldQty cho flash sale items\r\n      for (const [productId, flashInfo] of flashSaleMap) {\r\n        const cartItem = cart.cartItems.find(\r\n          (ci) => ci.productId === productId,\r\n        );\r\n        if (cartItem) {\r\n          await this.flashSaleService.incrementSoldQty(\r\n            flashInfo.flashSaleItemId,\r\n            cartItem.quantity,\r\n          );\r\n        }\r\n      }\r\n\r\n      // 4. Xóa giỏ hàng\r\n      await tx.cartItem.deleteMany({\r\n        where: { cartId: cart.id },\r\n      });\r\n\r\n      // 5. Ghi nhận sử dụng coupon\r\n      if (validCouponId) {\r\n        await tx.couponUsage.create({\r\n          data: {\r\n            couponId: validCouponId,\r\n            userId,\r\n            orderId: order.id,\r\n          },\r\n        });\r\n\r\n        await tx.coupon.update({\r\n          where: { id: validCouponId },\r\n          data: { usedCount: { increment: 1 } },\r\n        });\r\n      }\r\n\r\n      // 6. Gửi email xác nhận đơn hàng\r\n      const user = await tx.user.findUnique({ where: { id: userId } });\r\n      if (user?.email) {\r\n        void this.emailService.sendOrderConfirmationEmail(user.email, {\r\n          orderId: order.id,\r\n          totalAmount: finalAmount,\r\n          discountAmount,\r\n          items: cart.cartItems.map((item) => ({\r\n            name: item.product.name,\r\n            quantity: item.quantity,\r\n            price: item.product.price * item.quantity,\r\n          })),\r\n          address,\r\n          paymentMethod,\r\n        });\r\n      }\r\n\r\n      return order;\r\n    });\r\n  }\r\n\r\n  async findAll(userId: string) {\r\n    return this.prisma.order.findMany({\r\n      where: { userId, deletedAt: null },\r\n      include: {\r\n        orderItems: {\r\n          include: { product: true },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async findOne(id: string, userId: string) {\r\n    return this.prisma.order.findFirst({\r\n      where: { id, userId, deletedAt: null },\r\n      include: {\r\n        orderItems: {\r\n          include: { product: true },\r\n        },\r\n      },\r\n    });\r\n  }\r\n\r\n  // Admin APIs\r\n  async findAllAdmin() {\r\n    return this.prisma.order.findMany({\r\n      where: { deletedAt: null },\r\n      include: {\r\n        user: {\r\n          select: { id: true, email: true, fullName: true },\r\n        },\r\n        orderItems: {\r\n          include: {\r\n            product: { select: { id: true, name: true, imageUrl: true } },\r\n          },\r\n        },\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n    });\r\n  }\r\n\r\n  async updateStatus(id: string, status: OrderStatus) {\r\n    const order = await this.prisma.order.findUnique({\r\n      where: { id },\r\n      include: {\r\n        orderItems: {\r\n          include: { product: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!order) {\r\n      throw new NotFoundException('Đơn hàng không tồn tại');\r\n    }\r\n\r\n    // Nếu chuyển sang CANCELLED và đơn hàng trước đó không phải CANCELLED\r\n    // thì hoàn lại tồn kho\r\n    if (status === 'CANCELLED' && order.status !== 'CANCELLED') {\r\n      return this.prisma.$transaction(async (tx) => {\r\n        // Hoàn lại stock cho từng sản phẩm\r\n        for (const item of order.orderItems) {\r\n          await tx.product.update({\r\n            where: { id: item.productId },\r\n            data: { stock: { increment: item.quantity } },\r\n          });\r\n        }\r\n\r\n        // Cập nhật status đơn hàng\r\n        return tx.order.update({\r\n          where: { id },\r\n          data: { status },\r\n          include: {\r\n            user: {\r\n              select: { id: true, email: true, fullName: true },\r\n            },\r\n            orderItems: {\r\n              include: { product: { select: { id: true, name: true } } },\r\n            },\r\n          },\r\n        });\r\n      });\r\n    }\r\n\r\n    // Nếu không phải CANCELLED, chỉ cập nhật status bình thường\r\n    const updatedOrder = await this.prisma.order.update({\r\n      where: { id },\r\n      data: { status },\r\n      include: {\r\n        user: {\r\n          select: { id: true, email: true, fullName: true },\r\n        },\r\n        orderItems: {\r\n          include: { product: { select: { id: true, name: true } } },\r\n        },\r\n      },\r\n    });\r\n\r\n    // Gửi email thông báo cập nhật status\r\n    if (updatedOrder.user?.email) {\r\n      const statusLabels: Record<string, string> = {\r\n        PENDING: 'Chờ xử lý',\r\n        PROCESSING: 'Đang xử lý',\r\n        SHIPPED: 'Đang giao hàng',\r\n        DELIVERED: 'Đã giao hàng',\r\n        CANCELLED: 'Đã hủy',\r\n      };\r\n      void this.emailService.sendOrderStatusUpdateEmail(\r\n        updatedOrder.user.email,\r\n        {\r\n          orderId: id,\r\n          status,\r\n          statusLabel: statusLabels[status] || status,\r\n        },\r\n      );\r\n    }\r\n\r\n    // Tich diem loyalty khi DELIVERED\r\n    if (status === 'DELIVERED' && updatedOrder.user?.id) {\r\n      void this.loyaltyService.earnPoints(\r\n        updatedOrder.user.id,\r\n        id,\r\n        order.totalAmount,\r\n      );\r\n    }\r\n\r\n    return updatedOrder;\r\n  }\r\n\r\n  async getStats() {\r\n    const [totalOrders, totalRevenue, ordersByStatus] = await Promise.all([\r\n      this.prisma.order.count({ where: { deletedAt: null } }),\r\n      this.prisma.order.aggregate({\r\n        where: { deletedAt: null, status: { not: 'CANCELLED' } },\r\n        _sum: { totalAmount: true },\r\n      }),\r\n      this.prisma.order.groupBy({\r\n        by: ['status'],\r\n        _count: { status: true },\r\n        where: { deletedAt: null },\r\n      }),\r\n    ]);\r\n\r\n    return {\r\n      totalOrders,\r\n      totalRevenue: totalRevenue._sum.totalAmount || 0,\r\n      ordersByStatus: ordersByStatus.reduce(\r\n        (acc, item) => {\r\n          acc[item.status] = item._count.status;\r\n          return acc;\r\n        },\r\n        {} as Record<string, number>,\r\n      ),\r\n    };\r\n  }\r\n\r\n  async updatePaymentStatus(\r\n    orderId: string,\r\n    status: PaymentStatus,\r\n    momoTransId: string | null,\r\n  ) {\r\n    return this.prisma.order.update({\r\n      where: { id: orderId },\r\n      data: {\r\n        paymentStatus: status,\r\n        momoTransId: momoTransId,\r\n      },\r\n    });\r\n  }\r\n}\r\n"],"names":["OrdersService","createOrder","userId","address","phone","paymentMethod","couponId","province","cart","cartsService","getCart","cartItems","length","BadRequestException","flashSaleMap","Map","item","flashSaleInfo","flashSaleService","checkFlashSalePrice","productId","set","totalAmount","reduce","sum","flashInfo","get","price","salePrice","product","quantity","discountAmount","validCouponId","undefined","coupon","prisma","findUnique","where","id","isActive","existingUsage","couponUsage","couponId_userId","discountType","Math","floor","discountValue","maxDiscount","shippingFee","shippingResult","shippingService","calculateFee","fee","finalAmount","$transaction","tx","order","create","data","paymentStatus","stock","name","orderItem","orderId","update","cartItem","find","ci","incrementSoldQty","flashSaleItemId","deleteMany","cartId","usedCount","increment","user","email","emailService","sendOrderConfirmationEmail","items","map","findAll","findMany","deletedAt","include","orderItems","orderBy","createdAt","findOne","findFirst","findAllAdmin","select","fullName","imageUrl","updateStatus","status","NotFoundException","updatedOrder","statusLabels","PENDING","PROCESSING","SHIPPED","DELIVERED","CANCELLED","sendOrderStatusUpdateEmail","statusLabel","loyaltyService","earnPoints","getStats","totalOrders","totalRevenue","ordersByStatus","Promise","all","count","aggregate","not","_sum","groupBy","by","_count","acc","updatePaymentStatus","momoTransId"],"mappings":"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"}
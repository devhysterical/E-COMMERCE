{"version":3,"sources":["../../src/auth/otp-cache.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\n\r\ninterface OtpEntry {\r\n  otp: string;\r\n  expiresAt: number;\r\n}\r\n\r\n@Injectable()\r\nexport class OtpCacheService {\r\n  private cache = new Map<string, OtpEntry>();\r\n  private readonly TTL_MS = 5 * 60 * 1000; // 5 phút\r\n\r\n  // Tạo mã OTP 6 ký tự (A-Za-z0-9)\r\n  generateOtp(): string {\r\n    const chars =\r\n      'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\r\n    let otp = '';\r\n    for (let i = 0; i < 6; i++) {\r\n      otp += chars.charAt(Math.floor(Math.random() * chars.length));\r\n    }\r\n    return otp;\r\n  }\r\n\r\n  // Lưu OTP cho email\r\n  set(email: string, otp: string): void {\r\n    const normalizedEmail = email.toLowerCase();\r\n    this.cache.set(normalizedEmail, {\r\n      otp,\r\n      expiresAt: Date.now() + this.TTL_MS,\r\n    });\r\n\r\n    // Tự động xóa sau khi hết hạn\r\n    setTimeout(() => {\r\n      this.delete(normalizedEmail);\r\n    }, this.TTL_MS);\r\n  }\r\n\r\n  // Lấy OTP theo email\r\n  get(email: string): string | null {\r\n    const normalizedEmail = email.toLowerCase();\r\n    const entry = this.cache.get(normalizedEmail);\r\n\r\n    if (!entry) {\r\n      return null;\r\n    }\r\n\r\n    // Kiểm tra hết hạn\r\n    if (Date.now() > entry.expiresAt) {\r\n      this.delete(normalizedEmail);\r\n      return null;\r\n    }\r\n\r\n    return entry.otp;\r\n  }\r\n\r\n  // Xác thực OTP\r\n  verify(email: string, otp: string): boolean {\r\n    const storedOtp = this.get(email);\r\n    if (!storedOtp) {\r\n      return false;\r\n    }\r\n\r\n    const isValid = storedOtp === otp;\r\n    if (isValid) {\r\n      // Xóa OTP sau khi dùng\r\n      this.delete(email);\r\n    }\r\n\r\n    return isValid;\r\n  }\r\n\r\n  // Xóa OTP\r\n  delete(email: string): void {\r\n    this.cache.delete(email.toLowerCase());\r\n  }\r\n\r\n  // Kiểm tra có thể gửi lại OTP không (cooldown 60s)\r\n  canResend(email: string): { canResend: boolean; waitSeconds: number } {\r\n    const normalizedEmail = email.toLowerCase();\r\n    const entry = this.cache.get(normalizedEmail);\r\n\r\n    if (!entry) {\r\n      return { canResend: true, waitSeconds: 0 };\r\n    }\r\n\r\n    // Chỉ cho phép gửi lại sau 60s\r\n    const timeSinceCreated = Date.now() - (entry.expiresAt - this.TTL_MS);\r\n    const cooldownMs = 60 * 1000;\r\n\r\n    if (timeSinceCreated < cooldownMs) {\r\n      const waitSeconds = Math.ceil((cooldownMs - timeSinceCreated) / 1000);\r\n      return { canResend: false, waitSeconds };\r\n    }\r\n\r\n    return { canResend: true, waitSeconds: 0 };\r\n  }\r\n}\r\n"],"names":["OtpCacheService","generateOtp","chars","otp","i","charAt","Math","floor","random","length","set","email","normalizedEmail","toLowerCase","cache","expiresAt","Date","now","TTL_MS","setTimeout","delete","get","entry","verify","storedOtp","isValid","canResend","waitSeconds","timeSinceCreated","cooldownMs","ceil","Map"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBARc;;;;;;;AAQpB,IAAA,AAAMA,kBAAN,MAAMA;IAIX,iCAAiC;IACjCC,cAAsB;QACpB,MAAMC,QACJ;QACF,IAAIC,MAAM;QACV,IAAK,IAAIC,IAAI,GAAGA,IAAI,GAAGA,IAAK;YAC1BD,OAAOD,MAAMG,MAAM,CAACC,KAAKC,KAAK,CAACD,KAAKE,MAAM,KAAKN,MAAMO,MAAM;QAC7D;QACA,OAAON;IACT;IAEA,oBAAoB;IACpBO,IAAIC,KAAa,EAAER,GAAW,EAAQ;QACpC,MAAMS,kBAAkBD,MAAME,WAAW;QACzC,IAAI,CAACC,KAAK,CAACJ,GAAG,CAACE,iBAAiB;YAC9BT;YACAY,WAAWC,KAAKC,GAAG,KAAK,IAAI,CAACC,MAAM;QACrC;QAEA,8BAA8B;QAC9BC,WAAW;YACT,IAAI,CAACC,MAAM,CAACR;QACd,GAAG,IAAI,CAACM,MAAM;IAChB;IAEA,qBAAqB;IACrBG,IAAIV,KAAa,EAAiB;QAChC,MAAMC,kBAAkBD,MAAME,WAAW;QACzC,MAAMS,QAAQ,IAAI,CAACR,KAAK,CAACO,GAAG,CAACT;QAE7B,IAAI,CAACU,OAAO;YACV,OAAO;QACT;QAEA,mBAAmB;QACnB,IAAIN,KAAKC,GAAG,KAAKK,MAAMP,SAAS,EAAE;YAChC,IAAI,CAACK,MAAM,CAACR;YACZ,OAAO;QACT;QAEA,OAAOU,MAAMnB,GAAG;IAClB;IAEA,eAAe;IACfoB,OAAOZ,KAAa,EAAER,GAAW,EAAW;QAC1C,MAAMqB,YAAY,IAAI,CAACH,GAAG,CAACV;QAC3B,IAAI,CAACa,WAAW;YACd,OAAO;QACT;QAEA,MAAMC,UAAUD,cAAcrB;QAC9B,IAAIsB,SAAS;YACX,uBAAuB;YACvB,IAAI,CAACL,MAAM,CAACT;QACd;QAEA,OAAOc;IACT;IAEA,UAAU;IACVL,OAAOT,KAAa,EAAQ;QAC1B,IAAI,CAACG,KAAK,CAACM,MAAM,CAACT,MAAME,WAAW;IACrC;IAEA,mDAAmD;IACnDa,UAAUf,KAAa,EAA+C;QACpE,MAAMC,kBAAkBD,MAAME,WAAW;QACzC,MAAMS,QAAQ,IAAI,CAACR,KAAK,CAACO,GAAG,CAACT;QAE7B,IAAI,CAACU,OAAO;YACV,OAAO;gBAAEI,WAAW;gBAAMC,aAAa;YAAE;QAC3C;QAEA,+BAA+B;QAC/B,MAAMC,mBAAmBZ,KAAKC,GAAG,KAAMK,CAAAA,MAAMP,SAAS,GAAG,IAAI,CAACG,MAAM,AAAD;QACnE,MAAMW,aAAa,KAAK;QAExB,IAAID,mBAAmBC,YAAY;YACjC,MAAMF,cAAcrB,KAAKwB,IAAI,CAAC,AAACD,CAAAA,aAAaD,gBAAe,IAAK;YAChE,OAAO;gBAAEF,WAAW;gBAAOC;YAAY;QACzC;QAEA,OAAO;YAAED,WAAW;YAAMC,aAAa;QAAE;IAC3C;;aAtFQb,QAAQ,IAAIiB;aACHb,SAAS,IAAI,KAAK,MAAM,SAAS;;AAsFpD"}
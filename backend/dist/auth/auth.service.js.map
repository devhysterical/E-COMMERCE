{"version":3,"sources":["../../src/auth/auth.service.ts"],"sourcesContent":["import {\r\n  ConflictException,\r\n  Injectable,\r\n  UnauthorizedException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { JwtService } from '@nestjs/jwt';\r\nimport { UsersService } from '../users/users.service';\r\nimport { SupabaseService } from '../supabase/supabase.service';\r\nimport { EmailService } from '../email/email.service';\r\nimport { OtpCacheService } from './otp-cache.service';\r\nimport * as bcrypt from 'bcrypt';\r\nimport {\r\n  LoginDto,\r\n  RegisterDto,\r\n  ForgotPasswordDto,\r\n  GoogleAuthDto,\r\n} from './dto/auth.dto';\r\nimport { SendOtpDto } from './dto/otp.dto';\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n  constructor(\r\n    private usersService: UsersService,\r\n    private jwtService: JwtService,\r\n    private supabaseService: SupabaseService,\r\n    private emailService: EmailService,\r\n    private otpCacheService: OtpCacheService,\r\n  ) {}\r\n\r\n  // Gửi OTP đến email\r\n  async sendOtp(dto: SendOtpDto) {\r\n    // Kiểm tra cooldown\r\n    const { canResend, waitSeconds } = this.otpCacheService.canResend(\r\n      dto.email,\r\n    );\r\n    if (!canResend) {\r\n      throw new BadRequestException(\r\n        `Vui lòng đợi ${waitSeconds} giây trước khi gửi lại mã OTP`,\r\n      );\r\n    }\r\n\r\n    // Kiểm tra email đã tồn tại chưa\r\n    const userExists = await this.usersService.findOne(dto.email);\r\n    if (userExists) {\r\n      // Kiểm tra nếu user đã đăng ký qua Google\r\n      if (userExists.authProvider === 'google') {\r\n        throw new ConflictException(\r\n          'Email này đã được sử dụng để đăng nhập với Google. Vui lòng sử dụng tính năng \"Đăng nhập với Google\" thay thế.',\r\n        );\r\n      }\r\n      throw new ConflictException('Email đã được đăng ký');\r\n    }\r\n\r\n    // Tạo và lưu OTP\r\n    const otp = this.otpCacheService.generateOtp();\r\n    this.otpCacheService.set(dto.email, otp);\r\n\r\n    // Gửi email qua EmailService\r\n    await this.emailService.sendOtpEmail(dto.email, otp);\r\n\r\n    return { message: 'Mã OTP đã được gửi đến email của bạn' };\r\n  }\r\n\r\n  async register(dto: RegisterDto) {\r\n    // Verify OTP\r\n    const isOtpValid = this.otpCacheService.verify(dto.email, dto.otp);\r\n    if (!isOtpValid) {\r\n      throw new BadRequestException('Mã OTP không đúng hoặc đã hết hạn');\r\n    }\r\n\r\n    const userExists = await this.usersService.findOne(dto.email);\r\n    if (userExists) {\r\n      throw new ConflictException('Email đã tồn tại');\r\n    }\r\n\r\n    const hashedPassword = await bcrypt.hash(dto.password, 10);\r\n    const user = await this.usersService.create({\r\n      email: dto.email,\r\n      password: hashedPassword,\r\n      fullName: dto.fullName,\r\n    });\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n    const { password, ...result } = user;\r\n    return result;\r\n  }\r\n\r\n  async login(dto: LoginDto) {\r\n    const user = await this.usersService.findOne(dto.email);\r\n    if (!user) {\r\n      throw new UnauthorizedException('Thông tin đăng nhập không chính xác');\r\n    }\r\n\r\n    const isPasswordValid = await bcrypt.compare(dto.password, user.password);\r\n    if (!isPasswordValid) {\r\n      throw new UnauthorizedException('Thông tin đăng nhập không chính xác');\r\n    }\r\n\r\n    const payload = { sub: user.id, email: user.email, role: user.role };\r\n    return {\r\n      access_token: await this.jwtService.signAsync(payload),\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        fullName: user.fullName,\r\n        role: user.role,\r\n      },\r\n    };\r\n  }\r\n\r\n  async forgotPassword(dto: ForgotPasswordDto) {\r\n    // Không tiết lộ user có tồn tại hay không (bảo mật)\r\n    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:5173';\r\n    const redirectUrl = `${frontendUrl}/reset-password`;\r\n\r\n    try {\r\n      await this.supabaseService.sendPasswordResetEmail(dto.email, redirectUrl);\r\n    } catch {\r\n      // Không throw error để không tiết lộ email có tồn tại hay không\r\n    }\r\n\r\n    return {\r\n      message: 'Nếu email tồn tại, bạn sẽ nhận được link đặt lại mật khẩu.',\r\n    };\r\n  }\r\n\r\n  async googleAuth(dto: GoogleAuthDto) {\r\n    // Lấy thông tin user từ access token của Supabase\r\n    const googleUser = await this.supabaseService.getUserFromAccessToken(\r\n      dto.accessToken,\r\n    );\r\n\r\n    if (!googleUser) {\r\n      throw new UnauthorizedException('Token không hợp lệ');\r\n    }\r\n\r\n    // Kiểm tra user đã tồn tại chưa\r\n    let user = await this.usersService.findOne(googleUser.email);\r\n\r\n    if (!user) {\r\n      // Tạo user mới nếu chưa tồn tại\r\n      const randomPassword = await bcrypt.hash(Math.random().toString(36), 10);\r\n      user = await this.usersService.create({\r\n        email: googleUser.email,\r\n        password: randomPassword,\r\n        fullName: googleUser.fullName || undefined,\r\n        authProvider: 'google',\r\n      });\r\n\r\n      // Cập nhật avatar nếu có\r\n      if (googleUser.avatarUrl) {\r\n        await this.usersService.updateProfile(user.id, {\r\n          avatarUrl: googleUser.avatarUrl,\r\n        });\r\n      }\r\n    }\r\n\r\n    const payload = { sub: user.id, email: user.email, role: user.role };\r\n    return {\r\n      access_token: await this.jwtService.signAsync(payload),\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        fullName: user.fullName,\r\n        role: user.role,\r\n      },\r\n    };\r\n  }\r\n}\r\n"],"names":["AuthService","sendOtp","dto","canResend","waitSeconds","otpCacheService","email","BadRequestException","userExists","usersService","findOne","authProvider","ConflictException","otp","generateOtp","set","emailService","sendOtpEmail","message","register","isOtpValid","verify","hashedPassword","bcrypt","hash","password","user","create","fullName","result","login","UnauthorizedException","isPasswordValid","compare","payload","sub","id","role","access_token","jwtService","signAsync","forgotPassword","frontendUrl","process","env","FRONTEND_URL","redirectUrl","supabaseService","sendPasswordResetEmail","googleAuth","googleUser","getUserFromAccessToken","accessToken","randomPassword","Math","random","toString","undefined","avatarUrl","updateProfile"],"mappings":"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"}
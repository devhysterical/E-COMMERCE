{"version":3,"sources":["../../src/auth/refresh-token.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\r\nimport { PrismaService } from '../prisma/prisma.service';\r\nimport { randomUUID } from 'crypto';\r\nimport * as bcrypt from 'bcrypt';\r\n\r\n@Injectable()\r\nexport class RefreshTokenService {\r\n  private readonly REFRESH_TOKEN_EXPIRY_DAYS = 7;\r\n\r\n  constructor(private prisma: PrismaService) {}\r\n\r\n  async createRefreshToken(userId: string): Promise<string> {\r\n    // Xóa tất cả refresh tokens cũ của user (token rotation)\r\n    await this.prisma.refreshToken.deleteMany({ where: { userId } });\r\n\r\n    const rawToken = randomUUID();\r\n    const hashedToken = await bcrypt.hash(rawToken, 10);\r\n    const expiresAt = new Date();\r\n    expiresAt.setDate(expiresAt.getDate() + this.REFRESH_TOKEN_EXPIRY_DAYS);\r\n\r\n    await this.prisma.refreshToken.create({\r\n      data: {\r\n        userId,\r\n        token: hashedToken,\r\n        expiresAt,\r\n      },\r\n    });\r\n\r\n    return rawToken;\r\n  }\r\n\r\n  async validateRefreshToken(\r\n    rawToken: string,\r\n  ): Promise<{ userId: string } | null> {\r\n    // Tìm tất cả refresh tokens chưa hết hạn\r\n    const tokens = await this.prisma.refreshToken.findMany({\r\n      where: {\r\n        expiresAt: { gt: new Date() },\r\n      },\r\n    });\r\n\r\n    for (const tokenRecord of tokens) {\r\n      const isMatch = await bcrypt.compare(rawToken, tokenRecord.token);\r\n      if (isMatch) {\r\n        return { userId: tokenRecord.userId };\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  async revokeUserTokens(userId: string): Promise<void> {\r\n    await this.prisma.refreshToken.deleteMany({ where: { userId } });\r\n  }\r\n\r\n  async cleanupExpiredTokens(): Promise<void> {\r\n    await this.prisma.refreshToken.deleteMany({\r\n      where: { expiresAt: { lt: new Date() } },\r\n    });\r\n  }\r\n}\r\n"],"names":["RefreshTokenService","createRefreshToken","userId","prisma","refreshToken","deleteMany","where","rawToken","randomUUID","hashedToken","bcrypt","hash","expiresAt","Date","setDate","getDate","REFRESH_TOKEN_EXPIRY_DAYS","create","data","token","validateRefreshToken","tokens","findMany","gt","tokenRecord","isMatch","compare","revokeUserTokens","cleanupExpiredTokens","lt"],"mappings":";;;;+BAMaA;;;eAAAA;;;wBANc;+BACG;wBACH;gEACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGjB,IAAA,AAAMA,sBAAN,MAAMA;IAKX,MAAMC,mBAAmBC,MAAc,EAAmB;QACxD,yDAAyD;QACzD,MAAM,IAAI,CAACC,MAAM,CAACC,YAAY,CAACC,UAAU,CAAC;YAAEC,OAAO;gBAAEJ;YAAO;QAAE;QAE9D,MAAMK,WAAWC,IAAAA,kBAAU;QAC3B,MAAMC,cAAc,MAAMC,QAAOC,IAAI,CAACJ,UAAU;QAChD,MAAMK,YAAY,IAAIC;QACtBD,UAAUE,OAAO,CAACF,UAAUG,OAAO,KAAK,IAAI,CAACC,yBAAyB;QAEtE,MAAM,IAAI,CAACb,MAAM,CAACC,YAAY,CAACa,MAAM,CAAC;YACpCC,MAAM;gBACJhB;gBACAiB,OAAOV;gBACPG;YACF;QACF;QAEA,OAAOL;IACT;IAEA,MAAMa,qBACJb,QAAgB,EACoB;QACpC,yCAAyC;QACzC,MAAMc,SAAS,MAAM,IAAI,CAAClB,MAAM,CAACC,YAAY,CAACkB,QAAQ,CAAC;YACrDhB,OAAO;gBACLM,WAAW;oBAAEW,IAAI,IAAIV;gBAAO;YAC9B;QACF;QAEA,KAAK,MAAMW,eAAeH,OAAQ;YAChC,MAAMI,UAAU,MAAMf,QAAOgB,OAAO,CAACnB,UAAUiB,YAAYL,KAAK;YAChE,IAAIM,SAAS;gBACX,OAAO;oBAAEvB,QAAQsB,YAAYtB,MAAM;gBAAC;YACtC;QACF;QAEA,OAAO;IACT;IAEA,MAAMyB,iBAAiBzB,MAAc,EAAiB;QACpD,MAAM,IAAI,CAACC,MAAM,CAACC,YAAY,CAACC,UAAU,CAAC;YAAEC,OAAO;gBAAEJ;YAAO;QAAE;IAChE;IAEA,MAAM0B,uBAAsC;QAC1C,MAAM,IAAI,CAACzB,MAAM,CAACC,YAAY,CAACC,UAAU,CAAC;YACxCC,OAAO;gBAAEM,WAAW;oBAAEiB,IAAI,IAAIhB;gBAAO;YAAE;QACzC;IACF;IAlDA,YAAY,AAAQV,MAAqB,CAAE;aAAvBA,SAAAA;aAFHa,4BAA4B;IAED;AAmD9C"}